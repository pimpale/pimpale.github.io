import{c as a,n as u,r as p,j as v,k as E,l as L,o as M,p as b,q as f}from"./quat-BTiemoqx.js";function m(l){const i=l.x,s=l.y,e=1;let t;return i*i+s*s<=e*e/2?t=Math.sqrt(e*e-i*i-s*s):t=e*e/2/Math.sqrt(i*i+s*s),new Float32Array([i,-s,t])}class Q{constructor(i,s){this.zoomLevel=1,this.mouseLoc=null,this.baseQ=a(),this.currQ=a(),this.momentumQ=a(),this.currentMomentumLevel=0,this.getNormalizedMouseCoords=e=>{const t=this.canvas.getBoundingClientRect(),o=(t.left+t.right)/2,r=(t.top+t.bottom)/2,c=t.right-t.left,n=t.bottom-t.top,h=Math.min(c,n);return{x:2*(e.clientX-o)/h,y:2*(e.clientY-r)/h}},this.handleMouseDown=e=>{const t=this.getNormalizedMouseCoords(e);this.mouseLoc={start:t,current:t,previous:t}},this.handleMouseMove=e=>{if(this.mouseLoc===null)return;this.mouseLoc.previous=this.mouseLoc.current,this.mouseLoc.current=this.getNormalizedMouseCoords(e);const t=m(this.mouseLoc.start),o=m(this.mouseLoc.current);u(t,t),u(o,o),p(this.currQ,t,o)},this.handleMouseUp=e=>{if(this.mouseLoc===null)return;const t=m(this.mouseLoc.previous),o=m(this.mouseLoc.current);u(t,t),u(o,o),p(this.momentumQ,t,o),v(this.baseQ,this.currQ,this.baseQ),this.currQ=a(),this.mouseLoc=null,this.currentMomentumLevel=1},this.discardTouchEvent=e=>e.preventDefault(),this.handleWheel=e=>{if(!this.enableZoom)return;e.preventDefault();const t=e.deltaY>0?-1:1;this.zoomLevel*=1+t*this.zoomSpeed,this.zoomLevel=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoomLevel))},this.cleanup=()=>{this.canvas.removeEventListener("pointerdown",this.handleMouseDown),window.removeEventListener("pointermove",this.handleMouseMove),window.removeEventListener("pointerup",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.discardTouchEvent),this.canvas.removeEventListener("touchmove",this.discardTouchEvent),this.canvas.removeEventListener("touchend",this.discardTouchEvent),this.canvas.removeEventListener("touchcancel",this.discardTouchEvent)},this.update=()=>{if(this.mouseLoc===null){const e=E(a(),this.rotationQ,this.momentumQ,this.currentMomentumLevel);this.currentMomentumLevel*=this.dampingFactor,v(this.baseQ,e,this.baseQ)}},this.getTrackballCameraMatrix=(e,t)=>{const o=v(a(),this.currQ,this.baseQ),r=L();M(r,o);const c=L(),n=this.ortho,h=this.zoomLevel;b(c,n.left/h,n.right/h,n.bottom/h,n.top/h,n.near,n.far);const d=L();return f(d,c,r),d},s.ortho?this.ortho=s.ortho:this.ortho={left:-1,right:1,bottom:-1,top:1,near:-1,far:1},s.rotation?this.rotationQ=s.rotation:this.rotationQ=a(),s.dampingFactor!==void 0?this.dampingFactor=s.dampingFactor:this.dampingFactor=.9,this.enableZoom=s.enableZoom??!1,this.zoomSpeed=s.zoomSpeed??.1,this.minZoom=s.minZoom??.1,this.maxZoom=s.maxZoom??10,this.canvas=i,this.canvas.addEventListener("pointerdown",this.handleMouseDown),window.addEventListener("pointermove",this.handleMouseMove),window.addEventListener("pointerup",this.handleMouseUp),this.canvas.addEventListener("wheel",this.handleWheel,{passive:!1}),this.canvas.addEventListener("touchstart",this.discardTouchEvent),this.canvas.addEventListener("touchmove",this.discardTouchEvent),this.canvas.addEventListener("touchend",this.discardTouchEvent),this.canvas.addEventListener("touchcancel",this.discardTouchEvent)}}export{Q as T};
