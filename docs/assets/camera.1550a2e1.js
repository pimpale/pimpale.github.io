var U=1e-6,L=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});function D(){var r=new L(9);return L!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function F(){var r=new L(16);return L!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function P(r,e,t){var n=e[0],a=e[1],s=e[2],i=e[3],c=e[4],h=e[5],v=e[6],o=e[7],p=e[8],w=e[9],m=e[10],E=e[11],M=e[12],y=e[13],z=e[14],Q=e[15],l=t[0],u=t[1],f=t[2],d=t[3];return r[0]=l*n+u*c+f*p+d*M,r[1]=l*a+u*h+f*w+d*y,r[2]=l*s+u*v+f*m+d*z,r[3]=l*i+u*o+f*E+d*Q,l=t[4],u=t[5],f=t[6],d=t[7],r[4]=l*n+u*c+f*p+d*M,r[5]=l*a+u*h+f*w+d*y,r[6]=l*s+u*v+f*m+d*z,r[7]=l*i+u*o+f*E+d*Q,l=t[8],u=t[9],f=t[10],d=t[11],r[8]=l*n+u*c+f*p+d*M,r[9]=l*a+u*h+f*w+d*y,r[10]=l*s+u*v+f*m+d*z,r[11]=l*i+u*o+f*E+d*Q,l=t[12],u=t[13],f=t[14],d=t[15],r[12]=l*n+u*c+f*p+d*M,r[13]=l*a+u*h+f*w+d*y,r[14]=l*s+u*v+f*m+d*z,r[15]=l*i+u*o+f*E+d*Q,r}function I(r,e){var t=e[0],n=e[1],a=e[2],s=e[3],i=t+t,c=n+n,h=a+a,v=t*i,o=n*i,p=n*c,w=a*i,m=a*c,E=a*h,M=s*i,y=s*c,z=s*h;return r[0]=1-p-E,r[1]=o+z,r[2]=w-y,r[3]=0,r[4]=o-z,r[5]=1-v-E,r[6]=m+M,r[7]=0,r[8]=w+y,r[9]=m-M,r[10]=1-v-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function V(r,e,t,n,a,s,i){var c=1/(e-t),h=1/(n-a),v=1/(s-i);return r[0]=-2*c,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*h,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*v,r[11]=0,r[12]=(e+t)*c,r[13]=(a+n)*h,r[14]=(i+s)*v,r[15]=1,r}var Y=V,_=P;function R(){var r=new L(3);return L!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function W(r){var e=new L(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function O(r){var e=r[0],t=r[1],n=r[2];return Math.hypot(e,t,n)}function q(r,e,t){var n=new L(3);return n[0]=r,n[1]=e,n[2]=t,n}function x(r,e){var t=e[0],n=e[1],a=e[2],s=t*t+n*n+a*a;return s>0&&(s=1/Math.sqrt(s)),r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r}function B(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function $(r,e,t){var n=e[0],a=e[1],s=e[2],i=t[0],c=t[1],h=t[2];return r[0]=a*h-s*c,r[1]=s*i-n*h,r[2]=n*c-a*i,r}var S=O;(function(){var r=R();return function(e,t,n,a,s,i){var c,h;for(t||(t=3),n||(n=0),a?h=Math.min(a*t+n,e.length):h=e.length,c=n;c<h;c+=t)r[0]=e[c],r[1]=e[c+1],r[2]=e[c+2],s(r,r,i),e[c]=r[0],e[c+1]=r[1],e[c+2]=r[2];return e}})();function X(){var r=new L(4);return L!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function G(r,e){var t=e[0],n=e[1],a=e[2],s=e[3],i=t*t+n*n+a*a+s*s;return i>0&&(i=1/Math.sqrt(i)),r[0]=t*i,r[1]=n*i,r[2]=a*i,r[3]=s*i,r}(function(){var r=X();return function(e,t,n,a,s,i){var c,h;for(t||(t=4),n||(n=0),a?h=Math.min(a*t+n,e.length):h=e.length,c=n;c<h;c+=t)r[0]=e[c],r[1]=e[c+1],r[2]=e[c+2],r[3]=e[c+3],s(r,r,i),e[c]=r[0],e[c+1]=r[1],e[c+2]=r[2],e[c+3]=r[3];return e}})();function g(){var r=new L(4);return L!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function H(r,e,t){t=t*.5;var n=Math.sin(t);return r[0]=n*e[0],r[1]=n*e[1],r[2]=n*e[2],r[3]=Math.cos(t),r}function J(r,e,t){var n=e[0],a=e[1],s=e[2],i=e[3],c=t[0],h=t[1],v=t[2],o=t[3];return r[0]=n*o+i*c+a*v-s*h,r[1]=a*o+i*h+s*c-n*v,r[2]=s*o+i*v+n*h-a*c,r[3]=i*o-n*c-a*h-s*v,r}function A(r,e,t,n){var a=e[0],s=e[1],i=e[2],c=e[3],h=t[0],v=t[1],o=t[2],p=t[3],w,m,E,M,y;return m=a*h+s*v+i*o+c*p,m<0&&(m=-m,h=-h,v=-v,o=-o,p=-p),1-m>U?(w=Math.acos(m),E=Math.sin(w),M=Math.sin((1-n)*w)/E,y=Math.sin(n*w)/E):(M=1-n,y=n),r[0]=M*a+y*h,r[1]=M*s+y*v,r[2]=M*i+y*o,r[3]=M*c+y*p,r}function K(r,e){var t=e[0]+e[4]+e[8],n;if(t>0)n=Math.sqrt(t+1),r[3]=.5*n,n=.5/n,r[0]=(e[5]-e[7])*n,r[1]=(e[6]-e[2])*n,r[2]=(e[1]-e[3])*n;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[a*3+a]&&(a=2);var s=(a+1)%3,i=(a+2)%3;n=Math.sqrt(e[a*3+a]-e[s*3+s]-e[i*3+i]+1),r[a]=.5*n,n=.5/n,r[3]=(e[s*3+i]-e[i*3+s])*n,r[s]=(e[s*3+a]+e[a*3+s])*n,r[i]=(e[i*3+a]+e[a*3+i])*n}return r}function Z(r,e,t,n){var a=.5*Math.PI/180;e*=a,t*=a,n*=a;var s=Math.sin(e),i=Math.cos(e),c=Math.sin(t),h=Math.cos(t),v=Math.sin(n),o=Math.cos(n);return r[0]=s*h*o-i*c*v,r[1]=i*c*o+s*h*v,r[2]=i*h*v-s*c*o,r[3]=i*h*o+s*c*v,r}var b=J,N=G,C=function(){var r=R(),e=q(1,0,0),t=q(0,1,0);return function(n,a,s){var i=B(a,s);return i<-.999999?($(r,e,a),S(r)<1e-6&&$(r,t,a),x(r,r),H(n,r,Math.PI),n):i>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):($(r,a,s),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=1+i,N(n,n))}}();(function(){var r=g(),e=g();return function(t,n,a,s,i,c){return A(r,n,i,c),A(e,a,s,c),A(t,r,e,2*c*(1-c)),t}})();(function(){var r=D();return function(e,t,n,a){return r[0]=n[0],r[3]=n[1],r[6]=n[2],r[1]=a[0],r[4]=a[1],r[7]=a[2],r[2]=-t[0],r[5]=-t[1],r[8]=-t[2],N(e,K(e,r))}})();function T(r){const e=r.x,t=r.y,n=1;let a;return e*e+t*t<=n*n/2?a=Math.sqrt(n*n-e*e-t*t):a=n*n/2/Math.sqrt(e*e+t*t),new Float32Array([e,-t,a])}class k{constructor(e,t){this.mouseLoc=null,this.baseQ=g(),this.currQ=g(),this.momentumQ=g(),this.currentMomentumLevel=0,this.getNormalizedMouseCoords=n=>{const a=this.canvas.getBoundingClientRect(),s=(a.left+a.right)/2,i=(a.top+a.bottom)/2,c=a.right-a.left,h=a.bottom-a.top,v=Math.min(c,h);return{x:2*(n.clientX-s)/v,y:2*(n.clientY-i)/v}},this.handleMouseDown=n=>{const a=this.getNormalizedMouseCoords(n);this.mouseLoc={start:a,current:a,previous:a}},this.handleMouseMove=n=>{if(this.mouseLoc===null)return;this.mouseLoc.previous=this.mouseLoc.current,this.mouseLoc.current=this.getNormalizedMouseCoords(n);const a=T(this.mouseLoc.start),s=T(this.mouseLoc.current);x(a,a),x(s,s),C(this.currQ,a,s)},this.handleMouseUp=n=>{if(this.mouseLoc===null)return;const a=T(this.mouseLoc.previous),s=T(this.mouseLoc.current);x(a,a),x(s,s),C(this.momentumQ,a,s),b(this.baseQ,this.currQ,this.baseQ),this.currQ=g(),this.mouseLoc=null,this.currentMomentumLevel=1},this.discardTouchEvent=n=>n.preventDefault(),this.cleanup=()=>{this.canvas.removeEventListener("pointerdown",this.handleMouseDown),window.removeEventListener("pointermove",this.handleMouseMove),window.removeEventListener("pointerup",this.handleMouseUp),this.canvas.removeEventListener("touchstart",this.discardTouchEvent),this.canvas.removeEventListener("touchmove",this.discardTouchEvent),this.canvas.removeEventListener("touchend",this.discardTouchEvent),this.canvas.removeEventListener("touchcancel",this.discardTouchEvent)},this.update=()=>{if(this.mouseLoc===null){const n=A(g(),this.rotationQ,this.momentumQ,this.currentMomentumLevel);this.currentMomentumLevel*=this.dampingFactor,b(this.baseQ,n,this.baseQ)}},this.getTrackballCameraMatrix=(n,a)=>{const s=b(g(),this.currQ,this.baseQ),i=F();I(i,s);const c=F(),h=this.ortho;Y(c,h.left,h.right,h.bottom,h.top,h.near,h.far);const v=F();return _(v,c,i),v},t.ortho?this.ortho=t.ortho:this.ortho={left:-1,right:1,bottom:-1,top:1,near:-1,far:1},t.rotation?this.rotationQ=t.rotation:this.rotationQ=g(),t.dampingFactor!==void 0?this.dampingFactor=t.dampingFactor:this.dampingFactor=.9,this.canvas=e,this.canvas.addEventListener("pointerdown",this.handleMouseDown),window.addEventListener("pointermove",this.handleMouseMove),window.addEventListener("pointerup",this.handleMouseUp),this.canvas.addEventListener("touchstart",this.discardTouchEvent),this.canvas.addEventListener("touchmove",this.discardTouchEvent),this.canvas.addEventListener("touchend",this.discardTouchEvent),this.canvas.addEventListener("touchcancel",this.discardTouchEvent)}}export{L as A,k as T,Z as a,g as b,W as c,q as f};
