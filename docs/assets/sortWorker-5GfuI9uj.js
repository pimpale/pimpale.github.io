(function(){"use strict";var E=1e-6,b=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,r=arguments.length;r--;)n+=arguments[r]*arguments[r];return Math.sqrt(n)});function x(){var n=new b(9);return b!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function q(n,r,c,e,a,s,t,o,i,v){return n[0]=r,n[1]=c,n[2]=e,n[3]=a,n[4]=s,n[5]=t,n[6]=o,n[7]=i,n[8]=v,n}function P(n,r){if(n===r){var c=r[1],e=r[2],a=r[5];n[1]=r[3],n[2]=r[6],n[3]=c,n[5]=r[7],n[6]=e,n[7]=a}else n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8];return n}function U(n,r,c){var e=r[0],a=r[1],s=r[2],t=r[3],o=r[4],i=r[5],v=r[6],y=r[7],f=r[8],l=c[0],h=c[1],p=c[2],M=c[3],u=c[4],d=c[5],w=c[6],D=c[7],A=c[8];return n[0]=l*e+h*t+p*v,n[1]=l*a+h*o+p*y,n[2]=l*s+h*i+p*f,n[3]=M*e+u*t+d*v,n[4]=M*a+u*o+d*y,n[5]=M*s+u*i+d*f,n[6]=w*e+D*t+A*v,n[7]=w*a+D*o+A*y,n[8]=w*s+D*i+A*f,n}function g(){var n=new b(3);return b!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function T(n){var r=n[0],c=n[1],e=n[2];return Math.hypot(r,c,e)}function R(n,r,c){var e=new b(3);return e[0]=n,e[1]=r,e[2]=c,e}function V(n,r,c){return n[0]=r[0]+c[0],n[1]=r[1]+c[1],n[2]=r[2]+c[2],n}function _(n,r){var c=r[0],e=r[1],a=r[2],s=c*c+e*e+a*a;return s>0&&(s=1/Math.sqrt(s)),n[0]=r[0]*s,n[1]=r[1]*s,n[2]=r[2]*s,n}function G(n,r){return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]}function m(n,r,c){var e=r[0],a=r[1],s=r[2],t=c[0],o=c[1],i=c[2];return n[0]=a*i-s*o,n[1]=s*t-e*i,n[2]=e*o-a*t,n}function L(n,r,c){var e=c[0],a=c[1],s=c[2],t=c[3],o=r[0],i=r[1],v=r[2],y=a*v-s*i,f=s*o-e*v,l=e*i-a*o,h=a*l-s*f,p=s*y-e*l,M=e*f-a*y,u=t*2;return y*=u,f*=u,l*=u,h*=2,p*=2,M*=2,n[0]=o+y+h,n[1]=i+f+p,n[2]=v+l+M,n}var W=T;(function(){var n=g();return function(r,c,e,a,s,t){var o,i;for(c||(c=3),e||(e=0),a?i=Math.min(a*c+e,r.length):i=r.length,o=e;o<i;o+=c)n[0]=r[o],n[1]=r[o+1],n[2]=r[o+2],s(n,n,t),r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2];return r}})();function Y(){var n=new b(4);return b!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function C(n,r){var c=r[0],e=r[1],a=r[2],s=r[3],t=c*c+e*e+a*a+s*s;return t>0&&(t=1/Math.sqrt(t)),n[0]=c*t,n[1]=e*t,n[2]=a*t,n[3]=s*t,n}(function(){var n=Y();return function(r,c,e,a,s,t){var o,i;for(c||(c=4),e||(e=0),a?i=Math.min(a*c+e,r.length):i=r.length,o=e;o<i;o+=c)n[0]=r[o],n[1]=r[o+1],n[2]=r[o+2],n[3]=r[o+3],s(n,n,t),r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2],r[o+3]=n[3];return r}})();function I(){var n=new b(4);return b!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function N(n,r,c){c=c*.5;var e=Math.sin(c);return n[0]=e*r[0],n[1]=e*r[1],n[2]=e*r[2],n[3]=Math.cos(c),n}function O(n,r,c){var e=r[0],a=r[1],s=r[2],t=r[3],o=c[0],i=c[1],v=c[2],y=c[3];return n[0]=e*y+t*o+a*v-s*i,n[1]=a*y+t*i+s*o-e*v,n[2]=s*y+t*v+e*i-a*o,n[3]=t*y-e*o-a*i-s*v,n}function z(n,r,c,e){var a=r[0],s=r[1],t=r[2],o=r[3],i=c[0],v=c[1],y=c[2],f=c[3],l,h,p,M,u;return h=a*i+s*v+t*y+o*f,h<0&&(h=-h,i=-i,v=-v,y=-y,f=-f),1-h>E?(l=Math.acos(h),p=Math.sin(l),M=Math.sin((1-e)*l)/p,u=Math.sin(e*l)/p):(M=1-e,u=e),n[0]=M*a+u*i,n[1]=M*s+u*v,n[2]=M*t+u*y,n[3]=M*o+u*f,n}function Q(n,r){var c=r[0]+r[4]+r[8],e;if(c>0)e=Math.sqrt(c+1),n[3]=.5*e,e=.5/e,n[0]=(r[5]-r[7])*e,n[1]=(r[6]-r[2])*e,n[2]=(r[1]-r[3])*e;else{var a=0;r[4]>r[0]&&(a=1),r[8]>r[a*3+a]&&(a=2);var s=(a+1)%3,t=(a+2)%3;e=Math.sqrt(r[a*3+a]-r[s*3+s]-r[t*3+t]+1),n[a]=.5*e,e=.5/e,n[3]=(r[s*3+t]-r[t*3+s])*e,n[s]=(r[s*3+a]+r[a*3+s])*e,n[t]=(r[t*3+a]+r[a*3+t])*e}return n}var j=C;(function(){var n=g(),r=R(1,0,0),c=R(0,1,0);return function(e,a,s){var t=G(a,s);return t<-.999999?(m(n,r,a),W(n)<1e-6&&m(n,c,a),_(n,n),N(e,n,Math.PI),e):t>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(m(n,a,s),e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=1+t,j(e,e))}})(),function(){var n=I(),r=I();return function(c,e,a,s,t,o){return z(n,e,t,o),z(r,a,s,o),z(c,n,r,2*o*(1-o)),c}}(),function(){var n=x();return function(r,c,e,a){return n[0]=e[0],n[3]=e[1],n[6]=e[2],n[1]=a[0],n[4]=a[1],n[7]=a[2],n[2]=-c[0],n[5]=-c[1],n[8]=-c[2],j(r,Q(r,n))}}();function S(n,r){if(!n)throw new Error(r)}onmessage=n=>{console.log("[Worker] Received message");const{sceneGraph:r,viewMatrix:c,sortingAlgorithm:e}=n.data,a=performance.now(),s=[...r.values()].reduce((f,l)=>f+l.object.count,0),t={count:s,sceneMin:Float32Array.from([1/0,1/0,1/0]),sceneMax:Float32Array.from([-1/0,-1/0,-1/0]),colors:new Float32Array(s*3),positions:new Float32Array(s*3),opacities:new Float32Array(s),cov3Da:new Float32Array(s*3),cov3Db:new Float32Array(s*3),objectIds:new Uint32Array(s)};let o=0;for(const[f,l]of r.entries()){const h=f,p=l.object;t.colors.set(p.colors,o*3),t.opacities.set(p.opacities,o);const M=new Float32Array(p.count*3);for(let w=0;w<p.count;w++){const D=L(g(),p.positions.slice(w*3,w*3+3),l.rotation);V(D,D,l.translation),M.set(D,w*3),t.sceneMin=t.sceneMin.map((A,F)=>Math.min(A,D[F])),t.sceneMax=t.sceneMax.map((A,F)=>Math.max(A,D[F]))}t.positions.set(M,o*3);const u=new Float32Array(p.count*3),d=new Float32Array(p.count*3);for(let w=0;w<p.count;w++){const D=O(I(),p.rotations.slice(w*4,w*4+4),l.rotation),[A,F]=K(p.scales.slice(w*3,w*3+3),1,D);u.set(A,w*3),d.set(F,w*3)}t.cov3Da.set(u,o*3),t.cov3Db.set(d,o*3),t.objectIds.fill(h,o,o+p.count),o+=p.count}const i={count:s,sceneMin:t.sceneMin,sceneMax:t.sceneMax,colors:new Float32Array(s*3),positions:new Float32Array(s*3),opacities:new Float32Array(s),cov3Da:new Float32Array(s*3),cov3Db:new Float32Array(s*3),objectIds:new Uint32Array(s)},v=H(t.positions,c,e);for(let f=0;f<v.length;f++){const l=v[f];i.colors[f*3]=t.colors[l*3],i.colors[f*3+1]=t.colors[l*3+1],i.colors[f*3+2]=t.colors[l*3+2],i.positions[f*3]=t.positions[l*3],i.positions[f*3+1]=t.positions[l*3+1],i.positions[f*3+2]=t.positions[l*3+2],i.opacities[f]=t.opacities[l],i.objectIds[f]=t.objectIds[l],i.cov3Da[f*3]=t.cov3Da[l*3],i.cov3Da[f*3+1]=t.cov3Da[l*3+1],i.cov3Da[f*3+2]=t.cov3Da[l*3+2],i.cov3Db[f*3]=t.cov3Db[l*3],i.cov3Db[f*3+1]=t.cov3Db[l*3+1],i.cov3Db[f*3+2]=t.cov3Db[l*3+2]}S(i.cov3Da.length==3*t.count,"cov3Da count mismatch"),S(i.cov3Db.length==3*t.count,"cov3Db count mismatch");const y=`${((performance.now()-a)/1e3).toFixed(3)}s`;console.log(`[Worker] Sorted ${t.count} gaussians in ${y}. Algorithm: ${e}`),postMessage({data:i,sortTime:y},{transfer:[i.positions.buffer,i.colors.buffer,i.opacities.buffer,i.cov3Da.buffer,i.cov3Db.buffer,i.objectIds.buffer]})};function H(n,r,c){const e=n.length/3,a=t=>n[t*3]*r[2]+n[t*3+1]*r[6]+n[t*3+2]*r[10],s=new Uint32Array(e);if(c=="Array.sort"){const t=new Array(e).fill(0).map((o,i)=>({depth:a(i),index:i})).sort((o,i)=>o.depth-i.depth).map(o=>o.index);s.set(t)}else if(c=="quick sort"){const t=new Float32Array(e);for(let o=0;o<e;o++)s[o]=o,t[o]=a(o);$(t,s,0,e-1)}else if(c=="count sort"){let t=-1/0,o=1/0,i=new Int32Array(e);for(let l=0;l<e;l++){const h=a(l)*4096|0;i[l]=h,t=Math.max(t,h),o=Math.min(o,h)}let v=256*256/(t-o),y=new Uint32Array(256*256);for(let l=0;l<e;l++)i[l]=(i[l]-o)*v|0,y[i[l]]++;let f=new Uint32Array(256*256);for(let l=1;l<256*256;l++)f[l]=f[l-1]+y[l-1];for(let l=0;l<e;l++)s[f[i[l]]++]=l}return s}function $(n,r,c,e){if(c<e){const a=J(n,r,c,e);$(n,r,c,a),$(n,r,a+1,e)}}function J(n,r,c,e){const a=n[Math.floor((e-c)/2)+c];let s=c-1,t=e+1;for(;;){do s++;while(n[s]<a);do t--;while(n[t]>a);if(s>=t)return t;let o=n[s];n[s]=n[t],n[t]=o,o=r[s],r[s]=r[t],r[t]=o}}function K(n,r,c){const e=x(),a=x(),s=x(),t=x(),o=x();q(a,r*n[0],0,0,0,r*n[1],0,0,0,r*n[2]);const i=c[0],v=c[1],y=c[2],f=c[3];return q(s,1-2*(y*y+f*f),2*(v*y-i*f),2*(v*f+i*y),2*(v*y+i*f),1-2*(v*v+f*f),2*(y*f-i*v),2*(v*f-i*y),2*(y*f+i*v),1-2*(v*v+y*y)),U(t,a,s),U(o,P(e,t),t),[[o[0],o[1],o[2]],[o[4],o[5],o[8]]]}})();
