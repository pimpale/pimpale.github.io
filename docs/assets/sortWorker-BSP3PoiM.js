(function(){"use strict";var E=1e-6,A=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,n=arguments.length;n--;)r+=arguments[n]*arguments[n];return Math.sqrt(r)});function d(){var r=new A(9);return A!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function P(r,n,a,e,s,c,t,i,o,f){return r[0]=n,r[1]=a,r[2]=e,r[3]=s,r[4]=c,r[5]=t,r[6]=i,r[7]=o,r[8]=f,r}function S(r,n){if(r===n){var a=n[1],e=n[2],s=n[5];r[1]=n[3],r[2]=n[6],r[3]=a,r[5]=n[7],r[6]=e,r[7]=s}else r[0]=n[0],r[1]=n[3],r[2]=n[6],r[3]=n[1],r[4]=n[4],r[5]=n[7],r[6]=n[2],r[7]=n[5],r[8]=n[8];return r}function j(r,n,a){var e=n[0],s=n[1],c=n[2],t=n[3],i=n[4],o=n[5],f=n[6],y=n[7],l=n[8],v=a[0],h=a[1],p=a[2],M=a[3],x=a[4],z=a[5],F=a[6],w=a[7],D=a[8];return r[0]=v*e+h*t+p*f,r[1]=v*s+h*i+p*y,r[2]=v*c+h*o+p*l,r[3]=M*e+x*t+z*f,r[4]=M*s+x*i+z*y,r[5]=M*c+x*o+z*l,r[6]=F*e+w*t+D*f,r[7]=F*s+w*i+D*y,r[8]=F*c+w*o+D*l,r}function V(r,n){var a=n[0],e=n[1],s=n[2],c=n[3],t=a+a,i=e+e,o=s+s,f=a*t,y=e*t,l=e*i,v=s*t,h=s*i,p=s*o,M=c*t,x=c*i,z=c*o;return r[0]=1-l-p,r[3]=y-z,r[6]=v+x,r[1]=y+z,r[4]=1-f-p,r[7]=h-M,r[2]=v-x,r[5]=h+M,r[8]=1-f-l,r}function G(){var r=new A(16);return A!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function L(r,n,a,e){var s=n[0],c=n[1],t=n[2],i=n[3],o=s+s,f=c+c,y=t+t,l=s*o,v=s*f,h=s*y,p=c*f,M=c*y,x=t*y,z=i*o,F=i*f,w=i*y,D=e[0],b=e[1],g=e[2];return r[0]=(1-(p+x))*D,r[1]=(v+w)*D,r[2]=(h-F)*D,r[3]=0,r[4]=(v-w)*b,r[5]=(1-(l+x))*b,r[6]=(M+z)*b,r[7]=0,r[8]=(h+F)*g,r[9]=(M-z)*g,r[10]=(1-(l+p))*g,r[11]=0,r[12]=a[0],r[13]=a[1],r[14]=a[2],r[15]=1,r}function I(){var r=new A(3);return A!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function W(r){var n=r[0],a=r[1],e=r[2];return Math.hypot(n,a,e)}function $(r,n,a){var e=new A(3);return e[0]=r,e[1]=n,e[2]=a,e}function Y(r,n,a){return r[0]=n[0]*a,r[1]=n[1]*a,r[2]=n[2]*a,r}function q(r,n){var a=n[0],e=n[1],s=n[2],c=a*a+e*e+s*s;return c>0&&(c=1/Math.sqrt(c)),r[0]=n[0]*c,r[1]=n[1]*c,r[2]=n[2]*c,r}function C(r,n){return r[0]*n[0]+r[1]*n[1]+r[2]*n[2]}function m(r,n,a){var e=n[0],s=n[1],c=n[2],t=a[0],i=a[1],o=a[2];return r[0]=s*o-c*i,r[1]=c*t-e*o,r[2]=e*i-s*t,r}function N(r,n,a){var e=n[0],s=n[1],c=n[2],t=a[3]*e+a[7]*s+a[11]*c+a[15];return t=t||1,r[0]=(a[0]*e+a[4]*s+a[8]*c+a[12])/t,r[1]=(a[1]*e+a[5]*s+a[9]*c+a[13])/t,r[2]=(a[2]*e+a[6]*s+a[10]*c+a[14])/t,r}var O=W;(function(){var r=I();return function(n,a,e,s,c,t){var i,o;for(a||(a=3),e||(e=0),s?o=Math.min(s*a+e,n.length):o=n.length,i=e;i<o;i+=a)r[0]=n[i],r[1]=n[i+1],r[2]=n[i+2],c(r,r,t),n[i]=r[0],n[i+1]=r[1],n[i+2]=r[2];return n}})();function Q(){var r=new A(4);return A!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function H(r,n){var a=n[0],e=n[1],s=n[2],c=n[3],t=a*a+e*e+s*s+c*c;return t>0&&(t=1/Math.sqrt(t)),r[0]=a*t,r[1]=e*t,r[2]=s*t,r[3]=c*t,r}(function(){var r=Q();return function(n,a,e,s,c,t){var i,o;for(a||(a=4),e||(e=0),s?o=Math.min(s*a+e,n.length):o=n.length,i=e;i<o;i+=a)r[0]=n[i],r[1]=n[i+1],r[2]=n[i+2],r[3]=n[i+3],c(r,r,t),n[i]=r[0],n[i+1]=r[1],n[i+2]=r[2],n[i+3]=r[3];return n}})();function u(){var r=new A(4);return A!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function J(r,n,a){a=a*.5;var e=Math.sin(a);return r[0]=e*n[0],r[1]=e*n[1],r[2]=e*n[2],r[3]=Math.cos(a),r}function K(r,n,a){var e=n[0],s=n[1],c=n[2],t=n[3],i=a[0],o=a[1],f=a[2],y=a[3];return r[0]=e*y+t*i+s*f-c*o,r[1]=s*y+t*o+c*i-e*f,r[2]=c*y+t*f+e*o-s*i,r[3]=t*y-e*i-s*o-c*f,r}function U(r,n,a,e){var s=n[0],c=n[1],t=n[2],i=n[3],o=a[0],f=a[1],y=a[2],l=a[3],v,h,p,M,x;return h=s*o+c*f+t*y+i*l,h<0&&(h=-h,o=-o,f=-f,y=-y,l=-l),1-h>E?(v=Math.acos(h),p=Math.sin(v),M=Math.sin((1-e)*v)/p,x=Math.sin(e*v)/p):(M=1-e,x=e),r[0]=M*s+x*o,r[1]=M*c+x*f,r[2]=M*t+x*y,r[3]=M*i+x*l,r}function X(r,n){var a=n[0]+n[4]+n[8],e;if(a>0)e=Math.sqrt(a+1),r[3]=.5*e,e=.5/e,r[0]=(n[5]-n[7])*e,r[1]=(n[6]-n[2])*e,r[2]=(n[1]-n[3])*e;else{var s=0;n[4]>n[0]&&(s=1),n[8]>n[s*3+s]&&(s=2);var c=(s+1)%3,t=(s+2)%3;e=Math.sqrt(n[s*3+s]-n[c*3+c]-n[t*3+t]+1),r[s]=.5*e,e=.5/e,r[3]=(n[c*3+t]-n[t*3+c])*e,r[c]=(n[c*3+s]+n[s*3+c])*e,r[t]=(n[t*3+s]+n[s*3+t])*e}return r}var T=H;(function(){var r=I(),n=$(1,0,0),a=$(0,1,0);return function(e,s,c){var t=C(s,c);return t<-.999999?(m(r,n,s),O(r)<1e-6&&m(r,a,s),q(r,r),J(e,r,Math.PI),e):t>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(m(r,s,c),e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1+t,T(e,e))}})(),function(){var r=u(),n=u();return function(a,e,s,c,t,i){return U(r,e,t,i),U(n,s,c,i),U(a,r,n,2*i*(1-i)),a}}(),function(){var r=d();return function(n,a,e,s){return r[0]=e[0],r[3]=e[1],r[6]=e[2],r[1]=s[0],r[4]=s[1],r[7]=s[2],r[2]=-a[0],r[5]=-a[1],r[8]=-a[2],T(n,X(n,r))}}();function _(r,n){if(!r)throw new Error(n)}onmessage=r=>{console.log("[Worker] Received message");const{sceneGraph:n,viewMatrix:a,sortingAlgorithm:e}=r.data,s=performance.now(),c=[...n.values()].reduce((l,v)=>l+v.object.count,0),t={count:c,sceneMin:Float32Array.from([1/0,1/0,1/0]),sceneMax:Float32Array.from([-1/0,-1/0,-1/0]),colors:new Float32Array(c*3),positions:new Float32Array(c*3),opacities:new Float32Array(c),cov3Da:new Float32Array(c*3),cov3Db:new Float32Array(c*3),objectIds:new Uint32Array(c)};let i=0;for(const[l,v]of n.entries()){const h=l,p=v.object;t.colors.set(p.colors,i*3),t.opacities.set(p.opacities,i);const M=L(G(),v.rotation,v.translation,$(v.scale,v.scale,v.scale)),x=new Float32Array(p.count*3);for(let w=0;w<p.count;w++){const D=p.positions.slice(w*3,w*3+3);N(D,D,M),x.set(D,w*3),t.sceneMin=t.sceneMin.map((b,g)=>Math.min(b,D[g])),t.sceneMax=t.sceneMax.map((b,g)=>Math.max(b,D[g]))}t.positions.set(x,i*3);const z=new Float32Array(p.count*3),F=new Float32Array(p.count*3);for(let w=0;w<p.count;w++){const D=u();K(D,v.rotation,p.rotations.slice(w*4,w*4+4));const b=I();Y(b,p.scales.slice(w*3,w*3+3),v.scale);const[g,rr]=B(b,1,D);z.set(g,w*3),F.set(rr,w*3)}t.cov3Da.set(z,i*3),t.cov3Db.set(F,i*3),t.objectIds.fill(h,i,i+p.count),i+=p.count}const o={count:c,sceneMin:t.sceneMin,sceneMax:t.sceneMax,colors:new Float32Array(c*3),positions:new Float32Array(c*3),opacities:new Float32Array(c),cov3Da:new Float32Array(c*3),cov3Db:new Float32Array(c*3),objectIds:new Uint32Array(c)},f=Z(t.positions,a,e);for(let l=0;l<f.length;l++){const v=f[l];o.colors[l*3]=t.colors[v*3],o.colors[l*3+1]=t.colors[v*3+1],o.colors[l*3+2]=t.colors[v*3+2],o.positions[l*3]=t.positions[v*3],o.positions[l*3+1]=t.positions[v*3+1],o.positions[l*3+2]=t.positions[v*3+2],o.opacities[l]=t.opacities[v],o.objectIds[l]=t.objectIds[v],o.cov3Da[l*3]=t.cov3Da[v*3],o.cov3Da[l*3+1]=t.cov3Da[v*3+1],o.cov3Da[l*3+2]=t.cov3Da[v*3+2],o.cov3Db[l*3]=t.cov3Db[v*3],o.cov3Db[l*3+1]=t.cov3Db[v*3+1],o.cov3Db[l*3+2]=t.cov3Db[v*3+2]}_(o.cov3Da.length==3*t.count,"cov3Da count mismatch"),_(o.cov3Db.length==3*t.count,"cov3Db count mismatch");const y=`${((performance.now()-s)/1e3).toFixed(3)}s`;console.log(`[Worker] Sorted ${t.count} gaussians in ${y}. Algorithm: ${e}`),postMessage({data:o,sortTime:y},{transfer:[o.positions.buffer,o.colors.buffer,o.opacities.buffer,o.cov3Da.buffer,o.cov3Db.buffer,o.objectIds.buffer]})};function Z(r,n,a){const e=r.length/3,s=t=>r[t*3]*n[2]+r[t*3+1]*n[6]+r[t*3+2]*n[10],c=new Uint32Array(e);if(a=="Array.sort"){const t=new Array(e).fill(0).map((i,o)=>({depth:s(o),index:o})).sort((i,o)=>i.depth-o.depth).map(i=>i.index);c.set(t)}else if(a=="quick sort"){const t=new Float32Array(e);for(let i=0;i<e;i++)c[i]=i,t[i]=s(i);R(t,c,0,e-1)}else if(a=="count sort"){let t=-1/0,i=1/0,o=new Int32Array(e);for(let v=0;v<e;v++){const h=s(v)*4096|0;o[v]=h,t=Math.max(t,h),i=Math.min(i,h)}let f=256*256/(t-i),y=new Uint32Array(256*256);for(let v=0;v<e;v++)o[v]=(o[v]-i)*f|0,y[o[v]]++;let l=new Uint32Array(256*256);for(let v=1;v<256*256;v++)l[v]=l[v-1]+y[v-1];for(let v=0;v<e;v++)c[l[o[v]]++]=v}return c}function R(r,n,a,e){if(a<e){const s=k(r,n,a,e);R(r,n,a,s),R(r,n,s+1,e)}}function k(r,n,a,e){const s=r[Math.floor((e-a)/2)+a];let c=a-1,t=e+1;for(;;){do c++;while(r[c]<s);do t--;while(r[t]>s);if(c>=t)return t;let i=r[c];r[c]=r[t],r[t]=i,i=n[c],n[c]=n[t],n[t]=i}}function B(r,n,a){const e=d(),s=V(d(),a),c=d(),t=d();return P(e,n*r[0],0,0,0,n*r[1],0,0,0,n*r[2]),j(c,s,e),j(t,c,S(d(),c)),S(t,t),[[t[0],t[1],t[2]],[t[4],t[5],t[8]]]}})();
