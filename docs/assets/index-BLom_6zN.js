import"./modulepreload-polyfill-B5Qt9EMX.js";import{m as Et}from"./mod-DNNc6KTn.js";function q(h){return Math.PI*h/180}function st([h,e,t]){return Math.hypot(h,e,t)}function K(h){const e=st(h);return h.map(t=>t/e)}function G([h,e,t]){return[h,e,t]}function j([h,e,t],[s,o,a]){return h*s+e*o+t*a}function W([h,e,t],[s,o,a]){return[e*a-t*o,t*s-h*a,h*o-e*s]}function y(h,e){return[h[0]*e,h[1]*e,h[2]*e]}function v(h,e){return[h[0]+e[0],h[1]+e[1],h[2]+e[2]]}function O(h,e){return[h[0]-e[0],h[1]-e[1],h[2]-e[2]]}function ht(h){const[e,t,s,o]=h;return[[e[0],t[0],s[0],o[0]],[e[1],t[1],s[1],o[1]],[e[2],t[2],s[2],o[2]],[e[3],t[3],s[3],o[3]]]}function gt(h,e,t,s){const o=1/Math.tan(h/2),a=s-t;return[[o/e,0,0,0],[0,o,0,0],[0,0,-(t+s)/a,-2*t*s/a],[0,0,-1,0]]}function pt(h,e,t){let s=K(O(e,h));const o=K(W(s,t)),a=K(W(o,s));if(!o.every(r=>r==r))throw"two parallel vectors were given";s=y(s,-1);const i=xt(-j(o,h),-j(a,h),-j(s,h)),n=[[o[0],o[1],o[2],0],[a[0],a[1],a[2],0],[s[0],s[1],s[2],0],[0,0,0,1]];return $(i,n)}function xt(h,e,t){return[[1,0,0,h],[0,1,0,e],[0,0,1,t],[0,0,0,1]]}function R(h,e){return h[0]*e[0]+h[1]*e[1]+h[2]*e[2]+h[3]*e[3]}function $(h,e){const[t,s,o,a]=h,[i,n,r,l]=ht(e);return[[R(t,i),R(t,n),R(t,r),R(t,l)],[R(s,i),R(s,n),R(s,r),R(s,l)],[R(o,i),R(o,n),R(o,r),R(o,l)],[R(a,i),R(a,n),R(a,r),R(a,l)]]}function tt(h,e){return[h[0],h[1],h[2],e]}function F(h){return[h[0],h[1],h[2]]}function B(h,e){const[t,s,o,a]=h;return[R(t,e),R(s,e),R(o,e),R(a,e)]}function rt([h,e,t],s){const o=(u,p,g)=>{const d=Math.sqrt(u*u+p*p+g*g);return[u/d,p/d,g/d]};let[a,i,n]=o(h,e,t),[r,l]=[Math.cos(s),Math.sin(s)],c=1-r;return[[a*a*c+r,a*i*c-n*l,a*n*c+i*l,0],[a*i*c+n*l,i*i*c+r,i*n*c-a*l,0],[a*n*c-i*l,i*n*c+a*l,n*n*c+r,0],[0,0,0,1]]}function at(h){const[e,t,s,o]=ht(h);return[...e,...t,...s,...o]}function mt(h,e,t){return Math.min(Math.max(h,e),t)}function it(h,e){if(!h)throw new Error(e)}function M(h,e){const t=h%e;return t<0?t+e:t}function Tt(h,e){return Array(Math.max(e.length,h.length)).fill(void 0).map((t,s)=>[h[s],e[s]])}var k=(h=>(h[h.LEFT=0]="LEFT",h[h.RIGHT=1]="RIGHT",h[h.UP=2]="UP",h[h.DOWN=3]="DOWN",h[h.FRONT=4]="FRONT",h[h.BACK=5]="BACK",h))(k||{});function _t(h){switch(h){case 0:return[-1,0,0];case 1:return[1,0,0];case 2:return[0,-1,0];case 3:return[0,1,0];case 5:return[0,0,-1];case 4:return[0,0,1]}}class vt{constructor(e,t){this.buildTextureAtlas=s=>{let o=s.createTexture();s.bindTexture(s.TEXTURE_2D_ARRAY,o),s.pixelStorei(s.UNPACK_ALIGNMENT,1),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MAG_FILTER,s.NEAREST);const a=new Uint8Array(this.tileSize*this.tileSize*this.defs.length*6*4);s.texImage3D(s.TEXTURE_2D_ARRAY,0,s.RGBA,this.tileSize,this.tileSize,this.defs.length*6,0,s.RGBA,s.UNSIGNED_BYTE,a);for(let i=0;i<this.defs.length;i++){const n=this.defs[i];if(n.textures!==void 0)for(let r=0;r<n.textures.length;r++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,i*6+r,this.tileSize,this.tileSize,1,s.RGBA,s.UNSIGNED_BYTE,n.textures[r])}return s.generateMipmap(s.TEXTURE_2D_ARRAY),o},this.buildEmissiveTexture=s=>{const o=new Float32Array(this.defs.length);for(let i=0;i<this.defs.length;i++)o[i]=this.defs[i].light?1:0;const a=s.createTexture();return s.bindTexture(s.TEXTURE_2D,a),s.texImage2D(s.TEXTURE_2D,0,s.R32F,this.defs.length,1,0,s.RED,s.FLOAT,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),a},this.tileSize=e,this.defs=t;for(let s=0;s<this.defs.length;s++){const o=this.defs[s];if(o.textures!==void 0)for(let a=0;a<o.textures.length;a++){const i=o.textures[a];it(i.height===e,`block #${s} face #${a} height != ${e}, found ${i.height}`),it(i.width===e,`block #${s} face #${a} width != ${e}, found ${i.width}`)}}}}function Y(h,e,t){const s=h.createShader(e);return h.shaderSource(s,t),h.compileShader(s),s}function ct(h,e,t){const s=h.createProgram();for(const a of e)h.attachShader(s,a);for(const[a,i]of t)h.bindAttribLocation(s,a,i);if(h.linkProgram(s),h.getProgramParameter(s,h.LINK_STATUS))return s;for(const a of e)h.getShaderParameter(a,h.COMPILE_STATUS)||console.log(h.getShaderInfoLog(a)),h.deleteShader(a);return console.log(h.getProgramInfoLog(s)),h.deleteProgram(s),null}const kt=1,Rt=1,wt=1,At=1,yt=1,L=16,b=16,A=16,lt=2,ut=2,ft=2,H=1,z=1,V=1,Z=512,J=1024,bt=`#version 300 es
precision highp int;
precision highp float;
uniform mat4 u_mvpMat;

in vec3 a_position;
out vec3 v_position;

in vec3 a_tuv;
out vec3 v_tuv;

in vec3 a_normal;
out vec3 v_normal;

void main() {
   v_tuv = a_tuv;
   v_normal = a_normal;
   v_position = a_position;
   // actual location
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,Dt=`#version 300 es
precision highp int;
precision highp float;
precision highp isampler2D;
precision highp sampler2DArray;

// the texture atlas for the blocks
uniform sampler2DArray u_textureAtlas;

// 1D texture mapping block ID -> emissive value (0.0 or 1.0)
uniform sampler2D u_blockEmissive;

// Shared between all chunks
uniform sampler2DArray u_lightDepthArr;
uniform sampler2DArray u_lightDataArr;

// specific to the chunk.
// Contains 27 entries of start indexes and lengths
uniform isampler2D u_lightIndexes;

// position
in vec3 v_position;

// normal
in vec3 v_normal;

// texCoord
in vec3 v_tuv;

out vec4 v_outColor;

void main() {
  vec4 color = texture(u_textureAtlas, v_tuv);

  // Derive block ID from texture layer index (layer = blockId * 6 + face)
  int blockId = int(v_tuv.z) / 6;
  float emissive = texelFetch(u_blockEmissive, ivec2(blockId, 0), 0).r;

  float lightSum = 0.2 + emissive;

  int nLights = textureSize(u_lightIndexes, 0).x;
  for(int c = 0; c < nLights; c++) {
    int i = texelFetch(u_lightIndexes, ivec2(c, 0), 0).x;

    // get light position from texture
    vec3 lightPos = texelFetch(u_lightDataArr, ivec3(0, 0, i), 0).rgb;
    mat4 lightMvp = mat4(
        texelFetch(u_lightDataArr, ivec3(1, 0, i), 0),
        texelFetch(u_lightDataArr, ivec3(2, 0, i), 0),
        texelFetch(u_lightDataArr, ivec3(3, 0, i), 0),
        texelFetch(u_lightDataArr, ivec3(4, 0, i), 0)
    );
    vec4 lightSpacePosition = lightMvp * vec4(v_position, 1.0);

    vec3 projectedCoord = lightSpacePosition.xyz / lightSpacePosition.w;
    bool inRange =
        projectedCoord.z >= -1.0 &&
        projectedCoord.z <= 1.0 &&
        projectedCoord.x >= -1.0 &&
        projectedCoord.x <= 1.0 &&
        projectedCoord.y >= -1.0 &&
        projectedCoord.y <= 1.0;

    // remap coords to texCoords
    vec2 texCoord = (projectedCoord.xy + vec2(1.0, 1.0))/2.0;

    float depthMapDepth = texture(u_lightDepthArr, vec3(texCoord, i)).r;
    const float bias = 0.002;
    float currentDepth = (projectedCoord.z + 1.0)/2.0 - bias;

    if(inRange && currentDepth <= depthMapDepth) {
        float intensity = 1.0-currentDepth;
        vec3 lightDir = normalize(lightPos - v_position);
        float diffuseIntensity = max(dot(v_normal, lightDir), 0.0);
        lightSum += 7.0*diffuseIntensity*intensity;
    }
  }

  v_outColor = vec4(color.rgb*lightSum, color.a);
}
`,Lt=`#version 300 es
precision highp float;
in vec3 a_position;
uniform mat4 u_mvpMat;
void main() {
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,Ct=`#version 300 es
precision highp float;
out vec4 v_outColor;
void main() {
  v_outColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`;class It{constructor(e,t,s,o,a){this.POSITION_LOC=0,this.NORMAL_LOC=1,this.TUV_LOC=2,this.emptyChunk=new Uint16Array(L*b*A),this.getWorldChunkLoc=i=>[Math.floor(i[0]/L),Math.floor(i[1]/b),Math.floor(i[2]/A)],this.createGraphics=i=>{const n=this.gl.createVertexArray();this.gl.bindVertexArray(n);const r=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.POSITION_LOC),this.gl.vertexAttribPointer(this.POSITION_LOC,3,this.gl.FLOAT,!1,36,0),this.gl.enableVertexAttribArray(this.NORMAL_LOC),this.gl.vertexAttribPointer(this.NORMAL_LOC,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.TUV_LOC),this.gl.vertexAttribPointer(this.TUV_LOC,3,this.gl.FLOAT,!1,36,24),{vao:n,buffer:r,vertexCount:i.length/9}},this.deleteGraphics=i=>{this.gl.deleteBuffer(i.buffer),this.gl.deleteVertexArray(i.vao)},this.deleteChunkGraphics=i=>{this.deleteGraphics(i.solid),this.deleteGraphics(i.transparent)},this.deleteGPUData=i=>{this.gl.deleteTexture(i.lightIndexesTex)},this.shouldBeLoaded=i=>{const n=O(i,this.worldChunkCenterLoc);return n[0]>=-H&&n[0]<=H&&n[1]>=-z&&n[1]<=z&&n[2]>=-V&&n[2]<=V},this.shouldBeUnloaded=i=>{const n=O(i,this.worldChunkCenterLoc);return!(n[0]>=-lt&&n[0]<=lt&&n[1]>=-ut&&n[1]<=ut&&n[2]>=-ft&&n[2]<=ft)},this.unloadChunk=i=>{const n=this.chunk_map.get(i);n.graphics!==void 0&&this.deleteChunkGraphics(n.graphics),n.ownLights!==void 0&&this.freeLightIndexes.push(...n.ownLights.lightData.map(r=>r.index)),n.completeLighting!==void 0&&this.deleteGPUData(n.completeLighting.data);for(const r of this.adjacentChunkLocs(JSON.parse(i))){const l=this.chunk_map.get(JSON.stringify(r));l?.completeLighting!==void 0&&(l.completeLighting.stale=!0)}this.chunk_map.delete(i)},this.updateCameraLoc=()=>{for(const[r,l]of this.chunk_map)this.shouldBeUnloaded(JSON.parse(r))&&this.unloadChunk(r);for(let r=-H;r<=H;r++)for(let l=-z;l<=z;l++)for(let c=-V;c<=V;c++){const u=JSON.stringify(v(this.worldChunkCenterLoc,[r,l,c]));this.chunk_map.get(u)===void 0&&this.chunk_map.set(u,{})}const i=Array.from(this.chunk_map.keys(),r=>JSON.parse(r)).sort((r,l)=>{const c=st(O(r,this.worldChunkCenterLoc)),u=st(O(l,this.worldChunkCenterLoc));return c-u}),n=new Map;for(const r of i){const l=JSON.stringify(r);n.set(l,this.chunk_map.get(l))}this.chunk_map=n},this.addHighlight=(i,n)=>{const r=this.highlights.get(i);r!==void 0&&this.deleteGraphics(r);const l=this.createGraphics(et([{bi:6,cubeLoc:n.coords,face:n.face}]));this.highlights.set(i,l)},this.removeHighlight=i=>{const n=this.highlights.get(i);n!==void 0&&(this.deleteGraphics(n),this.highlights.delete(i))},this.createLightData=i=>{const n=v(i.cubeLoc,[.5,.5,.5]),r=gt(q(90),1,.5,10),l=i.face===k.UP||i.face===k.DOWN?[-1,0,0]:[0,-1,0],c=pt(n,v(n,_t(i.face)),l),u=$(r,c);return[n,u]},this.updateLightDataTex=(i,n)=>{const r=new Float32Array(20);{let[l,c]=n,[u,p,g,d]=ht(c);r.set(l,0),r.set(u,4),r.set(p,8),r.set(g,12),r.set(d,16)}this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.lightDataTexArr),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i,5,1,1,this.gl.RGBA,this.gl.FLOAT,r)},this.renderShadowMap=(i,n,r)=>{this.gl.useProgram(this.shadowProgram),this.gl.uniformMatrix4fv(this.shadowMvpMatLoc,!1,at(n)),this.gl.viewport(0,0,Z,Z),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.shadowFbs[i]),this.gl.clear(this.gl.DEPTH_BUFFER_BIT);for(const l of r)this.gl.bindVertexArray(l.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,l.vertexCount)},this.adjacentChunkLocs=i=>[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]].map(r=>v(i,r)),this.neighboringChunkLocs=i=>{const n=[];for(let r=-1;r<=1;r++)for(let l=-1;l<=1;l++)for(let c=-1;c<=1;c++)(c!==0||l!==0||r!==0)&&n.push(v(i,[r,l,c]));return n},this.getChunkBlocksIfExists=i=>{const n=this.chunk_map.get(JSON.stringify(i))?.blocks;return n||this.emptyChunk},this.update=i=>{let n=0;t:for(const[l,c]of this.chunk_map){const u=JSON.parse(l);if(c.blocks===void 0){c.blocks=Mt(u,this.noiseFn);for(const g of this.adjacentChunkLocs(u)){const d=this.chunk_map.get(JSON.stringify(g));d&&d.mesh&&(d.mesh.stale=!0)}n+=kt}if(n>1)break t;const p=[u[0]*L,u[1]*b,u[2]*A];if(c.mesh===void 0||c.mesh.stale){for(const f of this.adjacentChunkLocs(u))if(this.shouldBeLoaded(f)){const _=this.chunk_map.get(JSON.stringify(f));if(_===void 0||_.blocks===void 0)continue t}const{solid:g,transparent:d,lights:x}=St(p,this.blockManager,c.blocks,this.getChunkBlocksIfExists(v(u,[-1,0,0])),this.getChunkBlocksIfExists(v(u,[1,0,0])),this.getChunkBlocksIfExists(v(u,[0,-1,0])),this.getChunkBlocksIfExists(v(u,[0,1,0])),this.getChunkBlocksIfExists(v(u,[0,0,-1])),this.getChunkBlocksIfExists(v(u,[0,0,1])));c.mesh={solid:g,transparent:d,lights:x,stale:!1},c.graphics!==void 0&&(c.graphics.stale=!0),n+=Rt}if(n>1)break t;if(c.graphics===void 0||c.graphics.stale){c.graphics!==void 0&&this.deleteChunkGraphics(c.graphics),c.graphics={solid:this.createGraphics(et(c.mesh.solid)),transparent:this.createGraphics(et(c.mesh.transparent)),stale:!1},c.ownLights!==void 0&&(c.ownLights.stale=!0);for(const g of this.neighboringChunkLocs(u)){const d=this.chunk_map.get(JSON.stringify(g));d&&d.ownLights&&(d.ownLights.stale=!0)}n+=wt}if(n>1)break t;if(c.ownLights===void 0||c.ownLights.stale){const g=c.mesh.lights.map(this.createLightData);let d=!1;const x=c.ownLights===void 0?[]:c.ownLights.lightData.map(E=>E.index);let f=[];for(const[E,m]of Tt(g,x))if(E!==void 0&&m!==void 0&&f.push({matLoc:E,index:m}),E===void 0&&m!==void 0)this.freeLightIndexes.push(m),d=!0;else if(E!==void 0&&m===void 0){const T=this.freeLightIndexes.pop();T!==void 0?(f.push({matLoc:E,index:T}),d=!0):console.log("Ran out of lights!")}c.ownLights={stale:!0,lightData:f};const _=[c.graphics.solid];for(const E of this.neighboringChunkLocs(u)){const m=this.chunk_map.get(JSON.stringify(E));m&&m.graphics&&_.push(m.graphics.solid)}for(const{index:E,matLoc:m}of c.ownLights.lightData)this.renderShadowMap(E,m[1],_),this.updateLightDataTex(E,m);if(d){c.completeLighting!==void 0&&(c.completeLighting.stale=!0);for(const E of this.neighboringChunkLocs(u)){const m=this.chunk_map.get(JSON.stringify(E));m&&m.completeLighting&&(m.completeLighting.stale=!0)}}c.ownLights.stale=!1,n+=At}if(n>1)break t;if(c.completeLighting===void 0||c.completeLighting.stale){c.completeLighting===void 0&&(c.completeLighting={stale:!0,data:{lightIndexesTex:this.gl.createTexture()}});const g=[u,...this.neighboringChunkLocs(u)].map(d=>this.chunk_map.get(JSON.stringify(d))?.ownLights?.lightData).flatMap(d=>d===void 0?[]:d.map(x=>x.index));console.log(g),this.gl.bindTexture(this.gl.TEXTURE_2D,c.completeLighting.data.lightIndexesTex),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.R32I,g.length,1,0,this.gl.RED_INTEGER,this.gl.INT,new Int32Array(g)),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),c.completeLighting.stale=!1,n+=yt}if(n>1)break t}const r=this.getWorldChunkLoc(i);(r[0]!==this.worldChunkCenterLoc[0]||r[1]!==this.worldChunkCenterLoc[1]||r[2]!==this.worldChunkCenterLoc[2])&&(this.worldChunkCenterLoc=r,this.updateCameraLoc())},this.render=i=>{this.gl.useProgram(this.renderProgram),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.uniformMatrix4fv(this.renderMvpMatLoc,!1,at(i)),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.textureAtlas),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.blockEmissiveTex),this.gl.activeTexture(this.gl.TEXTURE2),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.shadowTexArr),this.gl.activeTexture(this.gl.TEXTURE3),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.lightDataTexArr);for(const n of this.chunk_map.values())n.graphics!==void 0&&n.completeLighting!==void 0&&(this.gl.bindVertexArray(n.graphics.solid.vao),this.gl.activeTexture(this.gl.TEXTURE4),this.gl.bindTexture(this.gl.TEXTURE_2D,n.completeLighting.data.lightIndexesTex),this.gl.drawArrays(this.gl.TRIANGLES,0,n.graphics.solid.vertexCount));this.gl.depthMask(!1);for(const n of this.chunk_map.values())n.graphics!==void 0&&(this.gl.bindVertexArray(n.graphics.transparent.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,n.graphics.transparent.vertexCount));this.gl.depthMask(!0),this.gl.disable(this.gl.DEPTH_TEST);for(const n of this.highlights.values())this.gl.bindVertexArray(n.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,n.vertexCount)},this.getBlock=i=>{const n=this.chunk_map.get(JSON.stringify(this.getWorldChunkLoc(i)));return n&&n.blocks?n.blocks[w(M(i[0],L),M(i[1],b),M(i[2],A))]:null},this.setBlock=(i,n)=>{const r=u=>{const p=this.chunk_map.get(JSON.stringify(u));p&&p.mesh&&(p.mesh.stale=!0)},l=this.getWorldChunkLoc(i),c=this.chunk_map.get(JSON.stringify(l));if(c&&c.blocks){const u=Math.floor(M(i[0],L)),p=Math.floor(M(i[1],b)),g=Math.floor(M(i[2],A));return c.blocks[w(u,p,g)]=n,r(l),u===0&&r(v(l,[-1,0,0])),u===L-1&&r(v(l,[1,0,0])),p===0&&r(v(l,[0,-1,0])),p===b-1&&r(v(l,[0,1,0])),g===0&&r(v(l,[0,0,-1])),g===A-1&&r(v(l,[0,0,1])),!0}else return!1},this.intbound=(i,n)=>{const r=Math.round(i)==i;if(n<0&&r)return 0;let l;return i==0?l=1:l=Math.ceil(i),(n>0?l-i:i-Math.floor(i))/Math.abs(n)},this.castRay=(i,n,r)=>{let l=Math.floor(i[0]),c=Math.floor(i[1]),u=Math.floor(i[2]);const[p,g,d]=n,x=Math.sign(p),f=Math.sign(g),_=Math.sign(d);let E=this.intbound(i[0],p),m=this.intbound(i[1],g),T=this.intbound(i[2],d);const C=x/p,I=f/g,nt=_/d;it(j(n,n)!==0,"direction vector is 0");const X=r/Math.sqrt(p*p+g*g+d*d);let P=k.UP;for(;;){const ot=this.getBlock([l,c,u]);if(ot===null)break;if(this.blockManager.defs[ot].pointable)return{coords:[l,c,u],face:P};if(E<m)if(E<T){if(E>X)break;l+=x,E+=C,P=x==1?k.LEFT:k.RIGHT}else{if(T>X)break;u+=_,T+=nt,P=_==1?k.BACK:k.FRONT}else if(m<T){if(m>X)break;c+=f,m+=I,P=f==1?k.UP:k.DOWN}else{if(T>X)break;u+=_,T+=nt,P=_==1?k.BACK:k.FRONT}}return null},this.gl=s,this.blockManager=o,this.seed=e,this.noiseFn=Et.makeNoise3D(e),this.worldChunkCenterLoc=this.getWorldChunkLoc(t),this.chunk_map=new Map,this.highlights=new Map,this.textureAtlas=this.blockManager.buildTextureAtlas(this.gl),this.blockEmissiveTex=this.blockManager.buildEmissiveTexture(this.gl),this.renderProgram=ct(this.gl,[Y(this.gl,this.gl.VERTEX_SHADER,bt),Y(this.gl,this.gl.FRAGMENT_SHADER,Dt)],new Map([[this.POSITION_LOC,"a_position"],[this.NORMAL_LOC,"a_normal"],[this.TUV_LOC,"a_tuv"]])),this.gl.useProgram(this.renderProgram),this.renderMvpMatLoc=this.gl.getUniformLocation(this.renderProgram,"u_mvpMat"),this.renderTextureAtlasLoc=this.gl.getUniformLocation(this.renderProgram,"u_textureAtlas"),this.renderBlockEmissiveLoc=this.gl.getUniformLocation(this.renderProgram,"u_blockEmissive"),this.renderLightDepthArrLoc=this.gl.getUniformLocation(this.renderProgram,"u_lightDepthArr"),this.renderLightDataArrLoc=this.gl.getUniformLocation(this.renderProgram,"u_lightDataArr"),this.renderLightIndexesLoc=this.gl.getUniformLocation(this.renderProgram,"u_lightIndexes"),this.gl.uniform1i(this.renderTextureAtlasLoc,0),this.gl.uniform1i(this.renderBlockEmissiveLoc,1),this.gl.uniform1i(this.renderLightDepthArrLoc,2),this.gl.uniform1i(this.renderLightDataArrLoc,3),this.gl.uniform1i(this.renderLightIndexesLoc,4),this.shadowProgram=ct(this.gl,[Y(this.gl,this.gl.VERTEX_SHADER,Lt),Y(this.gl,this.gl.FRAGMENT_SHADER,Ct)],new Map([[this.POSITION_LOC,"a_position"]])),this.gl.useProgram(this.shadowProgram),this.shadowMvpMatLoc=this.gl.getUniformLocation(this.shadowProgram,"u_mvpMat");{this.freeLightIndexes=[];for(let i=0;i<J;i++)this.freeLightIndexes.push(i);this.lightDataTexArr=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,this.lightDataTexArr),s.texImage3D(s.TEXTURE_2D_ARRAY,0,s.RGBA32F,5,1,J,0,s.RGBA,s.FLOAT,null),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MIN_FILTER,s.NEAREST),this.shadowTexArr=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,this.shadowTexArr),s.texImage3D(s.TEXTURE_2D_ARRAY,0,s.DEPTH_COMPONENT16,Z,Z,J,0,s.DEPTH_COMPONENT,s.UNSIGNED_SHORT,null),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MIN_FILTER,s.NEAREST),this.shadowFbs=[];for(let i=0;i<J;i++){const n=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,n),s.framebufferTextureLayer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,this.shadowTexArr,0,i),this.shadowFbs.push(n)}}this.updateCameraLoc()}}function w(h,e,t){return Math.floor(h)*b*A+Math.floor(e)*A+Math.floor(t)}function Mt(h,e){const t=[h[0]*L,h[1]*b,h[2]*A],s=new Uint16Array(L*b*A),o=20;for(let a=0;a<L;a++)for(let i=0;i<b;i++)for(let n=0;n<A;n++){const r=w(a,i,n),l=a+t[0],c=i+t[1],u=n+t[2],p=e(l/o,c/o,u/o),g=e(l/o,(c-1)/o,u/o);p>.5?g>.5?s[r]=3:s[r]=1:s[r]=0}return s[0]=5,s}function D(h,e){return!(h.textures===void 0||!h.transparent&&!e.transparent||h==e)}function St(h,e,t,s,o,a,i,n,r){const l=[],c=[],u=[];for(let p=0;p<L;p++)for(let g=0;g<b;g++)for(let d=0;d<A;d++){const x=t[w(p,g,d)],f=[h[0]+p,h[1]+g,h[2]+d],_=e.defs[x];if(_.textures===void 0)continue;const E=_.transparent?u:c;if(p===0?D(_,e.defs[s[w(L-1,g,d)]]):D(_,e.defs[t[w(p-1,g,d)]])){const m={bi:x,cubeLoc:f,face:k.LEFT};E.push(m),_.light&&l.push(m)}if(p===L-1?D(_,e.defs[o[w(0,g,d)]]):D(_,e.defs[t[w(p+1,g,d)]])){const m={bi:x,cubeLoc:f,face:k.RIGHT};E.push(m),_.light&&l.push(m)}if(g===0?D(_,e.defs[a[w(p,b-1,d)]]):D(_,e.defs[t[w(p,g-1,d)]])){const m={bi:x,cubeLoc:f,face:k.UP};E.push(m),_.light&&l.push(m)}if(g===b-1?D(_,e.defs[i[w(p,0,d)]]):D(_,e.defs[t[w(p,g+1,d)]])){const m={bi:x,cubeLoc:f,face:k.DOWN};E.push(m),_.light&&l.push(m)}if(d===0?D(_,e.defs[n[w(p,g,A-1)]]):D(_,e.defs[t[w(p,g,d-1)]])){const m={bi:x,cubeLoc:f,face:k.BACK};E.push(m),_.light&&l.push(m)}if(d===A-1?D(_,e.defs[r[w(p,g,0)]]):D(_,e.defs[t[w(p,g,d+1)]])){const m={bi:x,cubeLoc:f,face:k.FRONT};E.push(m),_.light&&l.push(m)}}return{solid:c,transparent:u,lights:l}}function et(h){const e=new Float32Array(h.length*6*9);let t=0;for(const{bi:s,face:o,cubeLoc:[a,i,n]}of h){const r=[a+0,i+0,n+0],l=[a+1,i+0,n+0],c=[a+0,i+0,n+1],u=[a+1,i+0,n+1],p=[a+0,i+1,n+0],g=[a+1,i+1,n+0],d=[a+0,i+1,n+1],x=[a+1,i+1,n+1],f=s*6+o,_=[-1,0,0],E=[1,0,0],m=[0,-1,0],T=[0,1,0],C=[0,0,-1],I=[0,0,1];switch(o){case k.LEFT:{e.set(r,t),t+=3,e.set(_,t),t+=3,e.set([1,0,f],t),t+=3,e.set(c,t),t+=3,e.set(_,t),t+=3,e.set([0,0,f],t),t+=3,e.set(p,t),t+=3,e.set(_,t),t+=3,e.set([1,1,f],t),t+=3,e.set(c,t),t+=3,e.set(_,t),t+=3,e.set([0,0,f],t),t+=3,e.set(d,t),t+=3,e.set(_,t),t+=3,e.set([0,1,f],t),t+=3,e.set(p,t),t+=3,e.set(_,t),t+=3,e.set([1,1,f],t),t+=3;break}case k.RIGHT:{e.set(l,t),t+=3,e.set(E,t),t+=3,e.set([0,0,f],t),t+=3,e.set(g,t),t+=3,e.set(E,t),t+=3,e.set([0,1,f],t),t+=3,e.set(u,t),t+=3,e.set(E,t),t+=3,e.set([1,0,f],t),t+=3,e.set(u,t),t+=3,e.set(E,t),t+=3,e.set([1,0,f],t),t+=3,e.set(g,t),t+=3,e.set(E,t),t+=3,e.set([0,1,f],t),t+=3,e.set(x,t),t+=3,e.set(E,t),t+=3,e.set([1,1,f],t),t+=3;break}case k.UP:{e.set(c,t),t+=3,e.set(m,t),t+=3,e.set([1,1,f],t),t+=3,e.set(r,t),t+=3,e.set(m,t),t+=3,e.set([1,0,f],t),t+=3,e.set(l,t),t+=3,e.set(m,t),t+=3,e.set([0,0,f],t),t+=3,e.set(c,t),t+=3,e.set(m,t),t+=3,e.set([1,1,f],t),t+=3,e.set(l,t),t+=3,e.set(m,t),t+=3,e.set([0,0,f],t),t+=3,e.set(u,t),t+=3,e.set(m,t),t+=3,e.set([0,1,f],t),t+=3;break}case k.DOWN:{e.set(p,t),t+=3,e.set(T,t),t+=3,e.set([0,0,f],t),t+=3,e.set(d,t),t+=3,e.set(T,t),t+=3,e.set([0,1,f],t),t+=3,e.set(g,t),t+=3,e.set(T,t),t+=3,e.set([1,0,f],t),t+=3,e.set(g,t),t+=3,e.set(T,t),t+=3,e.set([1,0,f],t),t+=3,e.set(d,t),t+=3,e.set(T,t),t+=3,e.set([0,1,f],t),t+=3,e.set(x,t),t+=3,e.set(T,t),t+=3,e.set([1,1,f],t),t+=3;break}case k.BACK:{e.set(r,t),t+=3,e.set(C,t),t+=3,e.set([0,0,f],t),t+=3,e.set(p,t),t+=3,e.set(C,t),t+=3,e.set([0,1,f],t),t+=3,e.set(l,t),t+=3,e.set(C,t),t+=3,e.set([1,0,f],t),t+=3,e.set(l,t),t+=3,e.set(C,t),t+=3,e.set([1,0,f],t),t+=3,e.set(p,t),t+=3,e.set(C,t),t+=3,e.set([0,1,f],t),t+=3,e.set(g,t),t+=3,e.set(C,t),t+=3,e.set([1,1,f],t),t+=3;break}case k.FRONT:{e.set(d,t),t+=3,e.set(I,t),t+=3,e.set([1,1,f],t),t+=3,e.set(c,t),t+=3,e.set(I,t),t+=3,e.set([1,0,f],t),t+=3,e.set(u,t),t+=3,e.set(I,t),t+=3,e.set([0,0,f],t),t+=3,e.set(d,t),t+=3,e.set(I,t),t+=3,e.set([1,1,f],t),t+=3,e.set(u,t),t+=3,e.set(I,t),t+=3,e.set([0,0,f],t),t+=3,e.set(x,t),t+=3,e.set(I,t),t+=3,e.set([0,1,f],t),t+=3;break}}}return e}class Nt{constructor(e,t,s,o){const a=tt(s,0),i=tt(o,0),n=tt(W(s,o),0),r=rt(s,t),l=F(B(r,i)),c=rt(l,e),u=$(c,r);this.right=F(B(u,i)),this.up=F(B(u,a)),this.front=F(B(u,n))}}class Ut{constructor(e,t,s){this.getPos=()=>G(this.pos),this.setPos=o=>this.pos=G(o),this.getDir=()=>G(this.dir),this.setDir=o=>this.dir=G(o),this.getMvp=o=>{const a=q(90),i=this.canvas.width/this.canvas.height,n=gt(a,i,.1,100),r=pt(this.pos,v(this.pos,this.dir),o);return $(n,r)},this.pos=e,this.dir=t,this.canvas=s}}class Q{}function Pt(h){function e(s){return s.toString(16).padStart(2,"0")}const t=new Uint8Array(h/2);return window.crypto.getRandomValues(t),Array.from(t,e).join("")}class Ot{constructor(e,t,s,o,a){this.update=()=>{for(const i of this.components)i.applySystem(this)},this.components=e,this.worldup=t,this.worldright=s,this.pos=o===void 0?[0,0,0]:o,this.dir=a===void 0?[1,0,0]:a}}class Xt extends Q{constructor(e,t,s){super(),this.pitch=0,this.yaw=0,this.controlsEnabled=!1,this.fast=!1,this.fly=!0,this.keys=new Set,this.leftMouseDown=!1,this.rightMouseDown=!1,this.applySystem=o=>{const a=new Nt(this.pitch,this.yaw,o.worldup,o.worldright);if(o.dir=y(a.front,-1),this.controlsEnabled){const i=K(W(a.right,o.worldup));let n=this.fast?.1:.04;this.fly?(this.keys.has("KeyW")&&this.physics.go(y(i,n)),this.keys.has("KeyS")&&this.physics.go(y(i,-n)),this.keys.has("KeyA")&&this.physics.go(y(a.right,n)),this.keys.has("KeyD")&&this.physics.go(y(a.right,-n)),this.keys.has("ShiftLeft")&&this.physics.go(y(o.worldup,-n)),this.keys.has("Space")&&this.physics.go(y(o.worldup,n))):(this.keys.has("KeyW")&&this.physics.go(y(i,n)),this.keys.has("KeyS")&&this.physics.go(y(i,-n)),this.keys.has("KeyA")&&this.physics.go(y(a.right,n)),this.keys.has("KeyD")&&this.physics.go(y(a.right,-n)),this.keys.has("Space")&&this.physics.jump()),this.keys.has("Digit1")&&(this.blockInteraction.placeID=1),this.keys.has("Digit2")&&(this.blockInteraction.placeID=2),this.keys.has("Digit3")&&(this.blockInteraction.placeID=3),this.keys.has("Digit4")&&(this.blockInteraction.placeID=4),this.keys.has("Digit5")&&(this.blockInteraction.placeID=5),this.leftMouseDown?this.blockInteraction.breakSelectedBlock():this.rightMouseDown&&this.blockInteraction.placeSelectedBlock()}},this.physics=t,this.blockInteraction=s,this.grabControlElement=e,window.addEventListener("keypress",o=>{o.key==="f"&&(this.fast=!this.fast),o.key==="m"&&(this.fly?(this.fly=!1,this.physics.enablePhysics()):(this.fly=!0,this.physics.disablePhysics()))}),window.addEventListener("keydown",o=>this.keys.add(o.code)),window.addEventListener("keyup",o=>this.keys.delete(o.code)),this.grabControlElement.addEventListener("click",o=>{this.grabControlElement.requestPointerLock()}),document.addEventListener("pointerlockchange",o=>{this.controlsEnabled=document.pointerLockElement===this.grabControlElement}),window.addEventListener("mousemove",o=>{if(!this.controlsEnabled)return;const a=.0015;this.yaw-=o.movementX*a,this.pitch+=o.movementY*a,this.pitch=mt(this.pitch,q(-89.9),q(89.9))}),window.addEventListener("mousedown",o=>{o.button===0?this.leftMouseDown=!0:o.button===2&&(this.rightMouseDown=!0)}),window.addEventListener("mouseup",o=>{o.button===0?this.leftMouseDown=!1:o.button===2&&(this.rightMouseDown=!1)})}}class Gt extends Q{constructor(e){super(),this.applySystem=t=>{this.camera.setDir(t.dir),this.camera.setPos(t.pos)},this.camera=e}}function S(h,e){return h.minX<=e.maxX&&h.maxX>=e.minX&&h.minY<=e.maxY&&h.maxY>=e.minY&&h.minZ<=e.maxZ&&h.maxZ>=e.minZ}class Ft extends Q{constructor(e){super(),this.upVel=0,this.wantGo=[0,0,0],this.wantJump=!1,this.x_rad=.3,this.z_rad=.3,this.p_y_rad=1.5,this.n_y_rad=.3,this.side_depth=.1,this.head_depth=.1,this.foot_depth=.6,this.physicsEnabled=!1,this.enablePhysics=()=>this.physicsEnabled=!0,this.disablePhysics=()=>{this.physicsEnabled=!1,this.upVel=0},this.getPhysicsEnabled=()=>this.physicsEnabled,this.go=t=>{this.wantGo=v(this.wantGo,t)},this.jump=()=>{this.wantJump=!0},this.calculatePlayerIntersection=t=>{let s={minX:t[0]-this.x_rad,maxX:t[0]-this.x_rad+this.side_depth,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},o={minX:t[0]+this.x_rad-this.side_depth,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},a={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]-this.z_rad+this.side_depth},i={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]+this.z_rad-this.side_depth,maxZ:t[2]+this.z_rad},n={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad,maxY:t[1]-this.n_y_rad+this.head_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},r={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]+this.p_y_rad-this.foot_depth,maxY:t[1]+this.p_y_rad,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},l=!1,c=!1,u=!1,p=!1,g=!1,d=!1;for(let x=-2;x<=2;x++)for(let f=-2;f<=2;f++)for(let _=-2;_<=2;_++){const E=v(t,[x,f,_]).map(T=>Math.floor(T)),m=this.world.getBlock(E);if(m!=null&&this.world.blockManager.defs[m].pointable){let T={minX:E[0],maxX:E[0]+1,minY:E[1],maxY:E[1]+1,minZ:E[2],maxZ:E[2]+1};!l&&S(s,T)&&(l=!0),!c&&S(o,T)&&(c=!0),!u&&S(n,T)&&(u=!0),!p&&S(r,T)&&(p=!0),!g&&S(a,T)&&(g=!0),!d&&S(i,T)&&(d=!0)}}return{left:l,right:c,up:u,down:p,back:g,front:d}},this.applySystem=t=>{if(!this.physicsEnabled){t.pos=v(t.pos,this.wantGo),this.wantGo=[0,0,0];return}this.upVel-=.001,this.upVel=mt(this.upVel,-.1,.1),this.wantGo=v(this.wantGo,y(t.worldup,this.upVel));let s=v(t.pos,this.wantGo);const o=this.calculatePlayerIntersection(s);this.wantJump&&o.down&&(this.upVel=.05),this.wantJump=!1,o.left&&(this.wantGo[0]=Math.max(this.wantGo[0],0)),o.right&&(this.wantGo[0]=Math.min(this.wantGo[0],0)),o.up&&(this.wantGo[1]=Math.max(this.wantGo[1],0),this.upVel=Math.min(this.upVel,0)),o.down&&(this.wantGo[1]=Math.min(this.wantGo[1],0),this.upVel=Math.max(this.upVel,0)),o.back&&(this.wantGo[2]=Math.max(this.wantGo[2],0)),o.front&&(this.wantGo[2]=Math.min(this.wantGo[2],0)),t.pos=v(t.pos,this.wantGo),this.wantGo=[0,0,0]},this.world=e}}class Bt extends Q{constructor(e,t){super(),this.placeID=2,this.ray=null,this.breakRequests=new Map,this.placeRequests=new Map,this.breakSelectedBlock=()=>{if(this.ray){const s=JSON.stringify(this.ray.coords),o=this.breakRequests.get(s);this.breakRequests.set(s,o===void 0?0:o+1)}},this.placeSelectedBlock=()=>{if(this.ray){const s=JSON.stringify(v(this.ray.coords,_t(this.ray.face))),o=this.placeRequests.get(s);this.placeRequests.set(s,o===void 0?0:o+1)}},this.applySystem=s=>{for(const[o,a]of this.breakRequests)a>30&&(this.world.setBlock(JSON.parse(o),0),this.breakRequests.delete(o));for(const[o,a]of this.placeRequests)a>20&&(this.world.setBlock(JSON.parse(o),this.placeID),this.placeRequests.delete(o));this.ray=this.world.castRay(this.camera.getPos(),this.camera.getDir(),100),this.ray?this.world.addHighlight(this.uniqueId,this.ray):this.world.removeHighlight(this.uniqueId)},this.uniqueId=Pt(32),this.camera=e,this.world=t}}const dt=[0,-1,0],Yt=[-1,0,0];class Ht{constructor(e,t){this.resizeCanvas=()=>{this.canvas.width=window.innerWidth/2,this.canvas.height=window.innerHeight/2},this.start=()=>this.animationLoop(),this.animationLoop=()=>{for(const i of this.entityList)i.update();this.world.update(this.camera.getPos()),this.world.render(this.camera.getMvp(dt)),this.requestID=window.requestAnimationFrame(this.animationLoop)},this.canvas=e,this.blockManager=t,this.camera=new Ut([0,0,0],[0,0,1],this.canvas),this.gl=e.getContext("webgl2"),this.world=new It(42,this.camera.getPos(),this.gl,t,this.camera);const s=new Ft(this.world),o=new Bt(this.camera,this.world),a=new Ot([new Xt(this.canvas,s,o),new Gt(this.camera),s,o],dt,Yt);this.entityList=[a],this.resizeCanvas(),window.addEventListener("resize",this.resizeCanvas)}}async function N(h){return new Promise((e,t)=>{const s=document.getElementById(h);s.onerror=t,s.onload=()=>e(s),s.complete&&e(s)})}async function U(h){return await Promise.all([N(`${h}-left`),N(`${h}-right`),N(`${h}-up`),N(`${h}-down`),N(`${h}-front`),N(`${h}-back`)])}async function zt(){const h=new vt(16,[{name:"air",pointable:!1,light:!1,transparent:!0},{name:"grass",pointable:!0,light:!1,transparent:!1,textures:await U("grass")},{name:"soil",pointable:!0,light:!1,transparent:!1,textures:await U("soil")},{name:"stone",pointable:!0,light:!1,transparent:!1,textures:await U("stone")},{name:"glass",pointable:!0,light:!1,transparent:!0,textures:await U("glass")},{name:"lamp",pointable:!0,light:!0,transparent:!1,textures:await U("lamp")},{name:"selector",pointable:!0,light:!0,transparent:!1,textures:await U("selector")}]),e=document.getElementById("canvas");new Ht(e,h).start()}zt();
