import"../modulepreload-polyfill.b7f2da20.js";import{m as ut}from"../mod.4956582c.js";function F(e){return Math.PI*e/180}function Q(e){let s=0;for(const t of e)s+=t*t;return Math.sqrt(s)}function D(e){const s=Q(e);return e.map(t=>t/s)}function Y([e,s,t]){return[e,s,t]}function W([e,s,t],[i,n,h]){return e*i+s*n+t*h}function H([e,s,t],[i,n,h]){return[s*h-t*n,t*i-e*h,e*n-s*i]}function b(e,s){return[e[0]*s,e[1]*s,e[2]*s]}function A(e,s){return[e[0]+s[0],e[1]+s[1],e[2]+s[2]]}function q(e,s){return[e[0]-s[0],e[1]-s[1],e[2]-s[2]]}function ot(e){const[s,t,i,n]=e;return[[s[0],t[0],i[0],n[0]],[s[1],t[1],i[1],n[1]],[s[2],t[2],i[2],n[2]],[s[3],t[3],i[3],n[3]]]}function nt(e,s,t,i){const n=1/Math.tan(e/2),h=i-t;return[[n/s,0,0,0],[0,n,0,0],[0,0,-(t+i)/h,-2*t*i/h],[0,0,-1,0]]}function ht(e,s,t){let i=D(q(s,e));const n=D(H(i,t)),h=D(H(n,i));if(!n.every(o=>o==o))throw"two parallel vectors were given";i=b(i,-1);const g=ft(-W(n,e),-W(h,e),-W(i,e)),r=[[n[0],n[1],n[2],0],[h[0],h[1],h[2],0],[i[0],i[1],i[2],0],[0,0,0,1]];return st(g,r)}function ft(e,s,t){return[[1,0,0,e],[0,1,0,s],[0,0,1,t],[0,0,0,1]]}function R(e,s){return e[0]*s[0]+e[1]*s[1]+e[2]*s[2]+e[3]*s[3]}function st(e,s){const[t,i,n,h]=e,[g,r,o,a]=ot(s);return[[R(t,g),R(t,r),R(t,o),R(t,a)],[R(i,g),R(i,r),R(i,o),R(i,a)],[R(n,g),R(n,r),R(n,o),R(n,a)],[R(h,g),R(h,r),R(h,o),R(h,a)]]}function j(e){const[s,t,i,n]=ot(e);return[...s,...t,...i,...n]}function gt(e,s,t){return Math.min(Math.max(e,s),t)}function tt(e,s){if(!e)throw new Error(s)}function P(e,s){const t=e%s;return t<0?t+s:t}var E=(e=>(e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.UP=2]="UP",e[e.DOWN=3]="DOWN",e[e.FRONT=4]="FRONT",e[e.BACK=5]="BACK",e))(E||{});function at(e){switch(e){case 0:return[-1,0,0];case 1:return[1,0,0];case 2:return[0,-1,0];case 3:return[0,1,0];case 5:return[0,0,-1];case 4:return[0,0,1]}}class dt{constructor(s,t){this.buildTextureAtlas=i=>{let n=i.createTexture();i.bindTexture(i.TEXTURE_2D_ARRAY,n),i.pixelStorei(i.UNPACK_ALIGNMENT,1),i.texParameteri(i.TEXTURE_2D_ARRAY,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D_ARRAY,i.TEXTURE_MAG_FILTER,i.NEAREST);const h=new Uint8Array(this.tileSize*this.tileSize*this.defs.length*6*4);i.texImage3D(i.TEXTURE_2D_ARRAY,0,i.RGBA,this.tileSize,this.tileSize,this.defs.length*6,0,i.RGBA,i.UNSIGNED_BYTE,h);for(let g=0;g<this.defs.length;g++){const r=this.defs[g];if(r.textures!==void 0)for(let o=0;o<r.textures.length;o++)i.texSubImage3D(i.TEXTURE_2D_ARRAY,0,0,0,g*6+o,this.tileSize,this.tileSize,1,i.RGBA,i.UNSIGNED_BYTE,r.textures[o])}return i.generateMipmap(i.TEXTURE_2D_ARRAY),n},this.tileSize=s,this.defs=t;for(let i=0;i<this.defs.length;i++){const n=this.defs[i];if(n.textures!==void 0)for(let h=0;h<n.textures.length;h++){const g=n.textures[h];tt(g.height===s,`block #${i} face #${h} height != ${s}, found ${g.height}`),tt(g.width===s,`block #${i} face #${h} width != ${s}, found ${g.width}`)}}}}function z(e,s,t){const i=e.createShader(s);return e.shaderSource(i,t),e.compileShader(i),i}function rt(e,s,t){const i=e.createProgram();for(const h of s)e.attachShader(i,h);for(const[h,g]of t)e.bindAttribLocation(i,h,g);if(e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS))return i;for(const h of s)e.getShaderParameter(h,e.COMPILE_STATUS)||console.log(e.getShaderInfoLog(h)),e.deleteShader(h);return console.log(e.getProgramInfoLog(i)),e.deleteProgram(i),null}const pt=1,mt=1,_t=1,vt=1,M=24,L=24,y=24,U=2,O=2,B=2,J=64,ct=20,X=9*ct,kt=`#version 300 es
precision highp int;
precision highp float;
uniform mat4 u_mvpMat;

in vec3 a_position;
out vec3 v_position;

in vec3 a_tuv;
out vec3 v_tuv;

in vec3 a_normal;
out vec3 v_normal;

void main() {
   v_tuv = a_tuv;
   v_normal = a_normal;
   v_position = a_position;
   // actual location
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,Et=`#version 300 es
precision highp int;
precision highp float;
precision highp sampler2DArray;

// the texture atlas for the blocks
uniform sampler2DArray u_textureAtlas;

uniform int u_lightNumber;

// the light depth maps
uniform sampler2DArray u_lightDepthArr;

// light position
uniform vec3 v_lightPosArr[${X}];

// camera view matrices of each point
uniform vec4 u_lightMvpArr[${X}*4];

// position
in vec3 v_position;

// normal
in vec3 v_normal;

// texCoord
in vec3 v_tuv;

out vec4 v_outColor;

void main() {
  vec4 color = texture(u_textureAtlas, v_tuv);

  float lightSum = 0.0;

  for(int i = 0; i < u_lightNumber; i++) {
    mat4 mvp = mat4(
        u_lightMvpArr[i*4 + 0],
        u_lightMvpArr[i*4 + 1],
        u_lightMvpArr[i*4 + 2],
        u_lightMvpArr[i*4 + 3]
    );
    vec4 lightSpacePosition = mvp * vec4(v_position, 1.0);

    vec3 projectedCoord = lightSpacePosition.xyz / lightSpacePosition.w;
    bool inRange =
        projectedCoord.z >= -1.0 &&
        projectedCoord.z <= 1.0 &&
        projectedCoord.x >= -1.0 &&
        projectedCoord.x <= 1.0 &&
        projectedCoord.y >= -1.0 &&
        projectedCoord.y <= 1.0;

    // remap coords to texCoords
    vec2 texCoord = (projectedCoord.xy + vec2(1.0, 1.0))/2.0;

    float depthMapDepth = texture(u_lightDepthArr, vec3(texCoord, i)).r;
    const float bias = 0.02;
    float currentDepth = (projectedCoord.z + 1.0)/2.0 - bias;

    if(inRange && currentDepth <= depthMapDepth) {
        float intensity = pow((1.0-currentDepth), 0.5);
        vec3 lightDir = normalize(v_lightPosArr[i] - v_position);
        float diffuseIntensity = max(dot(v_normal, lightDir), 0.0);
        lightSum += 2.0*diffuseIntensity*intensity;
    }
  }
  // global ambient light
  lightSum = max(lightSum, 0.2);
  v_outColor = vec4(color.rgb*lightSum, color.a);
}
`,At=`#version 300 es
precision highp float;
in vec3 a_position;
uniform mat4 u_mvpMat;
void main() {
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,Tt=`#version 300 es
precision highp float;
precision highp sampler2DArray;
in vec3 v_tuv;
out vec4 v_outColor;

void main() {
  v_outColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`;class wt{constructor(s,t,i,n,h,g){this.POSITION_LOC=0,this.NORMAL_LOC=1,this.TUV_LOC=2,this.emptyChunk=new Uint16Array(M*L*y),this.getWorldChunkLoc=r=>[Math.floor(r[0]/M),Math.floor(r[1]/L),Math.floor(r[2]/y)],this.createGraphics=r=>{const o=this.gl.createVertexArray();this.gl.bindVertexArray(o);const a=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.POSITION_LOC),this.gl.vertexAttribPointer(this.POSITION_LOC,3,this.gl.FLOAT,!1,9*4,0*4),this.gl.enableVertexAttribArray(this.NORMAL_LOC),this.gl.vertexAttribPointer(this.NORMAL_LOC,3,this.gl.FLOAT,!1,9*4,3*4),this.gl.enableVertexAttribArray(this.TUV_LOC),this.gl.vertexAttribPointer(this.TUV_LOC,3,this.gl.FLOAT,!1,9*4,6*4),{vao:o,buffer:a,vertexCount:r.length/9}},this.deleteGraphics=r=>{this.gl.deleteBuffer(r.buffer),this.gl.deleteVertexArray(r.vao)},this.deleteChunkGraphics=r=>{this.deleteGraphics(r.solid),this.deleteGraphics(r.transparent)},this.shouldBeLoaded=r=>{const o=q(r,this.worldChunkCenterLoc);return o[0]>=-U&&o[0]<=U&&o[1]>=-O&&o[1]<=O&&o[2]>=-B&&o[2]<=B},this.updateCameraLoc=()=>{for(const[o,a]of this.chunk_map)this.shouldBeLoaded(JSON.parse(o))||(a.graphics!==void 0&&this.deleteChunkGraphics(a.graphics),a.lights!==void 0&&this.freeChunkLightingGPUData.push(a.lights.data),this.chunk_map.delete(o));const r=[];for(let o=-U;o<=U;o++)for(let a=-O;a<=O;a++)for(let l=-B;l<=B;l++)r.push(A(this.worldChunkCenterLoc,[o,a,l]));r.sort((o,a)=>{const l=Q(q(o,this.worldChunkCenterLoc)),c=Q(q(a,this.worldChunkCenterLoc));return l-c});for(const o of r){const a=JSON.stringify(o);this.chunk_map.get(a)===void 0&&this.chunk_map.set(a,{})}},this.addHighlight=(r,o)=>{const a=this.highlights.get(r);a!==void 0&&this.deleteGraphics(a);const l=this.createGraphics($([{bi:5,cubeLoc:o.coords,face:o.face}]));this.highlights.set(r,l)},this.removeHighlight=r=>{const o=this.highlights.get(r);o!==void 0&&(this.deleteGraphics(o),this.highlights.delete(r))},this.createLightMatrix=r=>{const o=A(r.cubeLoc,[.5,.5,.5]),a=nt(F(90),1,.5,10),l=r.face===E.UP||r.face===E.DOWN?[-1,0,0]:[0,-1,0],c=ht(o,A(o,at(r.face)),l);return st(a,c)},this.renderShadowMap=(r,o,a,l)=>{this.gl.useProgram(this.shadowProgram),this.gl.uniformMatrix4fv(this.shadowMvpMatLoc,!1,j(a)),this.gl.viewport(0,0,J,J),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,o),this.gl.clear(this.gl.DEPTH_BUFFER_BIT);for(const c of l)this.gl.bindVertexArray(c.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,c.vertexCount)},this.adjacentChunkLocs=r=>[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]].map(a=>A(r,a)),this.neighboringChunkLocs=r=>{const o=[];for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++)for(let c=-1;c<=1;c++)(c!==0||l!==0||a!==0)&&o.push(A(r,[a,l,c]));return o},this.getChunkBlocksIfExists=r=>{var a;const o=(a=this.chunk_map.get(JSON.stringify(r)))==null?void 0:a.blocks;return o||this.emptyChunk},this.update=r=>{let o=0;t:for(const[l,c]of this.chunk_map){const f=JSON.parse(l);if(c.blocks===void 0){c.blocks=Rt(f,this.noiseFn);for(const m of this.adjacentChunkLocs(f)){const k=this.chunk_map.get(JSON.stringify(m));k&&k.mesh&&(k.mesh.stale=!0)}o+=pt}if(o>1)break t;const p=[f[0]*M,f[1]*L,f[2]*y];if(c.mesh===void 0||c.mesh.stale){for(const _ of this.adjacentChunkLocs(f))if(this.shouldBeLoaded(_)){const v=this.chunk_map.get(JSON.stringify(_));if(v===void 0||v.blocks===void 0)continue t}const{solid:m,transparent:k,lights:u}=yt(p,this.blockManager,c.blocks,this.getChunkBlocksIfExists(A(f,[-1,0,0])),this.getChunkBlocksIfExists(A(f,[1,0,0])),this.getChunkBlocksIfExists(A(f,[0,-1,0])),this.getChunkBlocksIfExists(A(f,[0,1,0])),this.getChunkBlocksIfExists(A(f,[0,0,-1])),this.getChunkBlocksIfExists(A(f,[0,0,1])));c.mesh={solid:m,transparent:k,lights:u,stale:!1},c.graphics!==void 0&&(c.graphics.stale=!0),c.lights!==void 0&&(c.lights.stale=!0);for(const _ of this.neighboringChunkLocs(f)){const v=this.chunk_map.get(JSON.stringify(_));v&&v.lights&&(v.lights.stale=!0)}o+=mt}if(o>1||((c.graphics===void 0||c.graphics.stale)&&(c.graphics!==void 0&&this.deleteChunkGraphics(c.graphics),c.graphics={solid:this.createGraphics($(c.mesh.solid)),transparent:this.createGraphics($(c.mesh.transparent)),stale:!1},o+=_t),o>1))break t;if(c.lights===void 0||c.lights.stale){const m=[f,...this.neighboringChunkLocs(f)],k=m.flatMap(d=>{const T=this.chunk_map.get(JSON.stringify(d));return T&&T.mesh?T.mesh.lights.slice(0,ct):[]}).slice(0,X),u=m.flatMap(d=>{const T=this.chunk_map.get(JSON.stringify(d));return T&&T.graphics?[T.graphics.solid]:[]}),_=k.map(d=>A(d.cubeLoc,[.5,.5,.5])),v=k.map(d=>this.createLightMatrix(d));if(c.lights===void 0){const d=this.freeChunkLightingGPUData.pop();if(d===void 0)continue;c.lights={matrixes:v,pos:_,data:d,stale:!0}}else c.lights.pos=_,c.lights.matrixes=v;for(let d=0;d<c.lights.matrixes.length;d++)this.renderShadowMap(c.lights.data.tex,c.lights.data.fbs[d],c.lights.matrixes[d],u);c.lights.stale=!1,o+=vt}if(o>1)break t}const a=this.getWorldChunkLoc(r);(a[0]!==this.worldChunkCenterLoc[0]||a[1]!==this.worldChunkCenterLoc[1]||a[2]!==this.worldChunkCenterLoc[2])&&(this.worldChunkCenterLoc=a,this.updateCameraLoc())},this.render=r=>{this.gl.useProgram(this.renderProgram),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.uniformMatrix4fv(this.renderMvpMatLoc,!1,j(r)),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(const o of this.chunk_map.values())if(o.graphics!==void 0&&o.lights!==void 0){if(this.gl.bindVertexArray(o.graphics.solid.vao),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.textureAtlas),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,o.lights.data.tex),this.gl.uniform1i(this.renderLightNumber,o.lights.matrixes.length),o.lights.pos.length>0){const a=new Float32Array(o.lights.matrixes.length*16);for(let c=0;c<o.lights.matrixes.length;c++)a.set(j(o.lights.matrixes[c]),c*16);this.gl.uniform4fv(this.renderLightMvpArr,a);const l=new Float32Array(o.lights.pos.length*3);for(let c=0;c<o.lights.pos.length;c++)l.set(o.lights.pos[c],c*3);this.gl.uniform3fv(this.renderLightPosArr,l)}this.gl.drawArrays(this.gl.TRIANGLES,0,o.graphics.solid.vertexCount)}this.gl.depthMask(!1);for(const o of this.chunk_map.values())o.graphics!==void 0&&(this.gl.bindVertexArray(o.graphics.transparent.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,o.graphics.transparent.vertexCount));this.gl.depthMask(!0),this.gl.disable(this.gl.DEPTH_TEST);for(const o of this.highlights.values())this.gl.bindVertexArray(o.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,o.vertexCount)},this.getBlock=r=>{const o=this.chunk_map.get(JSON.stringify(this.getWorldChunkLoc(r)));return o&&o.blocks?o.blocks[w(P(r[0],M),P(r[1],L),P(r[2],y))]:null},this.setBlock=(r,o)=>{const a=f=>{const p=this.chunk_map.get(JSON.stringify(l));p&&p.mesh&&(p.mesh.stale=!0)},l=this.getWorldChunkLoc(r),c=this.chunk_map.get(JSON.stringify(l));if(c&&c.blocks){const f=P(r[0],M),p=P(r[1],L),m=P(r[2],y);return c.blocks[w(f,p,m)]=o,a(),f===0&&a(A(l,[-1,0,0])),f===M-1&&a(A(l,[1,0,0])),p===0&&a(A(l,[0,-1,0])),p===L-1&&a(A(l,[0,1,0])),m===0&&a(A(l,[0,0,-1])),m===y-1&&a(A(l,[0,0,1])),!0}else return!1},this.intbound=(r,o)=>{const a=Math.round(r)==r;if(o<0&&a)return 0;let l;return r==0?l=1:l=Math.ceil(r),(o>0?l-r:r-Math.floor(r))/Math.abs(o)},this.castRay=(r,o,a)=>{let l=Math.floor(r[0]),c=Math.floor(r[1]),f=Math.floor(r[2]);const[p,m,k]=o,u=Math.sign(p),_=Math.sign(m),v=Math.sign(k);let d=this.intbound(r[0],p),T=this.intbound(r[1],m),C=this.intbound(r[2],k);const S=u/p,lt=_/m,et=v/k;tt(W(o,o)!==0,"direction vector is 0");const K=a/Math.sqrt(p*p+m*m+k*k);let I=E.UP;for(;;){const it=this.getBlock([l,c,f]);if(it===null)break;if(this.blockManager.defs[it].pointable)return{coords:[l,c,f],face:I};if(d<T)if(d<C){if(d>K)break;l+=u,d+=S,I=u==1?E.LEFT:E.RIGHT}else{if(C>K)break;f+=v,C+=et,I=v==1?E.BACK:E.FRONT}else if(T<C){if(T>K)break;c+=_,T+=lt,I=_==1?E.UP:E.DOWN}else{if(C>K)break;f+=v,C+=et,I=v==1?E.BACK:E.FRONT}}return null},this.gl=n,this.blockManager=h,this.seed=s,this.worldup=i,this.noiseFn=ut.makeNoise3D(s),this.worldChunkCenterLoc=this.getWorldChunkLoc(t),this.chunk_map=new Map,this.highlights=new Map,this.renderProgram=rt(this.gl,[z(this.gl,this.gl.VERTEX_SHADER,kt),z(this.gl,this.gl.FRAGMENT_SHADER,Et)],new Map([[this.POSITION_LOC,"a_position"],[this.NORMAL_LOC,"a_normal"],[this.TUV_LOC,"a_tuv"]])),this.gl.useProgram(this.renderProgram),this.renderMvpMatLoc=this.gl.getUniformLocation(this.renderProgram,"u_mvpMat"),this.renderTextureAtlasLoc=this.gl.getUniformLocation(this.renderProgram,"u_textureAtlas"),this.renderLightNumber=this.gl.getUniformLocation(this.renderProgram,"u_lightNumber"),this.renderLightDepthArr=this.gl.getUniformLocation(this.renderProgram,"u_lightDepthArr"),this.renderLightMvpArr=this.gl.getUniformLocation(this.renderProgram,"u_lightMvpArr"),this.renderLightPosArr=this.gl.getUniformLocation(this.renderProgram,"v_lightPosArr"),this.gl.activeTexture(this.gl.TEXTURE0),this.textureAtlas=this.blockManager.buildTextureAtlas(this.gl),this.gl.uniform1i(this.renderTextureAtlasLoc,0),this.gl.uniform1i(this.renderLightDepthArr,1),this.shadowProgram=rt(this.gl,[z(this.gl,this.gl.VERTEX_SHADER,At),z(this.gl,this.gl.FRAGMENT_SHADER,Tt)],new Map([[this.POSITION_LOC,"a_position"]])),this.gl.useProgram(this.shadowProgram),this.shadowMvpMatLoc=this.gl.getUniformLocation(this.shadowProgram,"u_mvpMat"),this.freeChunkLightingGPUData=[];for(let r=0;r<(U*2+1)*(O*2+1)*(B*2+1);r++)this.freeChunkLightingGPUData.push(Ct(this.gl));this.updateCameraLoc()}}function w(e,s,t){return Math.floor(e)*L*y+Math.floor(s)*y+Math.floor(t)}function Rt(e,s){const t=[e[0]*M,e[1]*L,e[2]*y],i=new Uint16Array(M*L*y),n=20;for(let h=0;h<M;h++)for(let g=0;g<L;g++)for(let r=0;r<y;r++){const o=w(h,g,r),a=h+t[0],l=g+t[1],c=r+t[2],f=s(a/n,l/n,c/n),p=s(a/n,(l-1)/n,c/n);f>0?p>0?i[o]=3:i[o]=1:i[o]=0}return i[w(16,16,16)]=5,i}function x(e,s){return!(e.textures===void 0||!e.transparent&&!s.transparent||e==s)}function yt(e,s,t,i,n,h,g,r,o){const a=[],l=[],c=[];for(let f=0;f<M;f++)for(let p=0;p<L;p++)for(let m=0;m<y;m++){const k=t[w(f,p,m)],u=[e[0]+f,e[1]+p,e[2]+m],_=s.defs[k];if(_.textures===void 0)continue;const v=_.transparent?c:l;if(f===0?x(_,s.defs[i[w(M-1,p,m)]]):x(_,s.defs[t[w(f-1,p,m)]])){const d={bi:k,cubeLoc:u,face:E.LEFT};v.push(d),_.light&&a.push(d)}if(f===M-1?x(_,s.defs[n[w(0,p,m)]]):x(_,s.defs[t[w(f+1,p,m)]])){const d={bi:k,cubeLoc:u,face:E.RIGHT};v.push(d),_.light&&a.push(d)}if(p===0?x(_,s.defs[h[w(f,L-1,m)]]):x(_,s.defs[t[w(f,p-1,m)]])){const d={bi:k,cubeLoc:u,face:E.UP};v.push(d),_.light&&a.push(d)}if(p===L-1?x(_,s.defs[g[w(f,0,m)]]):x(_,s.defs[t[w(f,p+1,m)]])){const d={bi:k,cubeLoc:u,face:E.DOWN};v.push(d),_.light&&a.push(d)}if(m===0?x(_,s.defs[r[w(f,p,y-1)]]):x(_,s.defs[t[w(f,p,m-1)]])){const d={bi:k,cubeLoc:u,face:E.BACK};v.push(d),_.light&&a.push(d)}if(m===y-1?x(_,s.defs[o[w(f,p,0)]]):x(_,s.defs[t[w(f,p,m+1)]])){const d={bi:k,cubeLoc:u,face:E.FRONT};v.push(d),_.light&&a.push(d)}}return{solid:l,transparent:c,lights:a}}function $(e){const s=new Float32Array(e.length*6*9);let t=0;for(const{bi:i,face:n,cubeLoc:[h,g,r]}of e){const o=[h+0,g+0,r+0],a=[h+1,g+0,r+0],l=[h+0,g+0,r+1],c=[h+1,g+0,r+1],f=[h+0,g+1,r+0],p=[h+1,g+1,r+0],m=[h+0,g+1,r+1],k=[h+1,g+1,r+1],u=i*6+n,_=[-1,0,0],v=[1,0,0],d=[0,-1,0],T=[0,1,0],C=[0,0,-1],S=[0,0,1];switch(n){case E.LEFT:{s.set(o,t),t+=3,s.set(_,t),t+=3,s.set([1,0,u],t),t+=3,s.set(l,t),t+=3,s.set(_,t),t+=3,s.set([0,0,u],t),t+=3,s.set(f,t),t+=3,s.set(_,t),t+=3,s.set([1,1,u],t),t+=3,s.set(l,t),t+=3,s.set(_,t),t+=3,s.set([0,0,u],t),t+=3,s.set(m,t),t+=3,s.set(_,t),t+=3,s.set([0,1,u],t),t+=3,s.set(f,t),t+=3,s.set(_,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.RIGHT:{s.set(a,t),t+=3,s.set(v,t),t+=3,s.set([0,0,u],t),t+=3,s.set(p,t),t+=3,s.set(v,t),t+=3,s.set([0,1,u],t),t+=3,s.set(c,t),t+=3,s.set(v,t),t+=3,s.set([1,0,u],t),t+=3,s.set(c,t),t+=3,s.set(v,t),t+=3,s.set([1,0,u],t),t+=3,s.set(p,t),t+=3,s.set(v,t),t+=3,s.set([0,1,u],t),t+=3,s.set(k,t),t+=3,s.set(v,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.UP:{s.set(l,t),t+=3,s.set(d,t),t+=3,s.set([1,1,u],t),t+=3,s.set(o,t),t+=3,s.set(d,t),t+=3,s.set([1,0,u],t),t+=3,s.set(a,t),t+=3,s.set(d,t),t+=3,s.set([0,0,u],t),t+=3,s.set(l,t),t+=3,s.set(d,t),t+=3,s.set([1,1,u],t),t+=3,s.set(a,t),t+=3,s.set(d,t),t+=3,s.set([0,0,u],t),t+=3,s.set(c,t),t+=3,s.set(d,t),t+=3,s.set([0,1,u],t),t+=3;break}case E.DOWN:{s.set(f,t),t+=3,s.set(T,t),t+=3,s.set([0,0,u],t),t+=3,s.set(m,t),t+=3,s.set(T,t),t+=3,s.set([0,1,u],t),t+=3,s.set(p,t),t+=3,s.set(T,t),t+=3,s.set([1,0,u],t),t+=3,s.set(p,t),t+=3,s.set(T,t),t+=3,s.set([1,0,u],t),t+=3,s.set(m,t),t+=3,s.set(T,t),t+=3,s.set([0,1,u],t),t+=3,s.set(k,t),t+=3,s.set(T,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.BACK:{s.set(o,t),t+=3,s.set(C,t),t+=3,s.set([0,0,u],t),t+=3,s.set(f,t),t+=3,s.set(C,t),t+=3,s.set([0,1,u],t),t+=3,s.set(a,t),t+=3,s.set(C,t),t+=3,s.set([1,0,u],t),t+=3,s.set(a,t),t+=3,s.set(C,t),t+=3,s.set([1,0,u],t),t+=3,s.set(f,t),t+=3,s.set(C,t),t+=3,s.set([0,1,u],t),t+=3,s.set(p,t),t+=3,s.set(C,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.FRONT:{s.set(m,t),t+=3,s.set(S,t),t+=3,s.set([1,1,u],t),t+=3,s.set(l,t),t+=3,s.set(S,t),t+=3,s.set([1,0,u],t),t+=3,s.set(c,t),t+=3,s.set(S,t),t+=3,s.set([0,0,u],t),t+=3,s.set(m,t),t+=3,s.set(S,t),t+=3,s.set([1,1,u],t),t+=3,s.set(c,t),t+=3,s.set(S,t),t+=3,s.set([0,0,u],t),t+=3,s.set(k,t),t+=3,s.set(S,t),t+=3,s.set([0,1,u],t),t+=3;break}}}return s}const Ct=e=>{const s=e.createTexture();e.bindTexture(e.TEXTURE_2D_ARRAY,s),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.DEPTH_COMPONENT32F,J,J,X,0,e.DEPTH_COMPONENT,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const t=[];for(let i=0;i<X;i++){const n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n),e.framebufferTextureLayer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,s,0,i),t.push(n)}return{tex:s,fbs:t}};class Lt{constructor(s,t,i){this.front=D([Math.cos(t)*Math.cos(s),Math.sin(s),Math.sin(t)*Math.cos(s)]),this.right=D(H(this.front,i)),this.up=D(H(this.right,this.front))}}class xt{constructor(s,t,i,n){this.getPos=()=>Y(this.pos),this.setPos=h=>this.pos=Y(h),this.getDir=()=>Y(this.dir),this.setDir=h=>this.dir=Y(h),this.getMvp=()=>{const h=F(90),g=this.canvas.width/this.canvas.height,r=nt(h,g,.1,100),o=ht(this.pos,A(this.pos,this.dir),this.worldup);return st(r,o)},this.pos=s,this.dir=t,this.canvas=i,this.worldup=n}}class V{}function bt(e){function s(i){return i.toString(16).padStart(2,"0")}const t=new Uint8Array(e/2);return window.crypto.getRandomValues(t),Array.from(t,s).join("")}class Mt{constructor(s,t,i,n){this.update=()=>{for(const h of this.components)h.applySystem(this)},this.components=s,this.worldup=t,this.pos=i===void 0?[0,0,0]:i,this.dir=n===void 0?[1,0,0]:n}}class St extends V{constructor(s,t,i){super(),this.pitch=0,this.yaw=F(-90),this.controlsEnabled=!1,this.fast=!1,this.fly=!0,this.keys=new Set,this.leftMouseDown=!1,this.rightMouseDown=!1,this.applySystem=n=>{const h=new Lt(this.pitch,this.yaw,n.worldup);if(n.dir=b(h.front,-1),this.controlsEnabled){const g=D(H(h.right,n.worldup));let r=this.fast?.1:.04;this.fly?(this.keys.has("KeyW")&&this.physics.go(b(g,r)),this.keys.has("KeyS")&&this.physics.go(b(g,-r)),this.keys.has("KeyA")&&this.physics.go(b(h.right,r)),this.keys.has("KeyD")&&this.physics.go(b(h.right,-r)),this.keys.has("ShiftLeft")&&this.physics.go(b(n.worldup,-r)),this.keys.has("Space")&&this.physics.go(b(n.worldup,r))):(this.keys.has("KeyW")&&this.physics.go(b(g,r)),this.keys.has("KeyS")&&this.physics.go(b(g,-r)),this.keys.has("KeyA")&&this.physics.go(b(h.right,r)),this.keys.has("KeyD")&&this.physics.go(b(h.right,-r)),this.keys.has("Space")&&this.physics.jump()),this.keys.has("Digit1")&&(this.blockInteraction.placeID=1),this.keys.has("Digit2")&&(this.blockInteraction.placeID=2),this.keys.has("Digit3")&&(this.blockInteraction.placeID=3),this.keys.has("Digit4")&&(this.blockInteraction.placeID=4),this.keys.has("Digit5")&&(this.blockInteraction.placeID=5),this.leftMouseDown?this.blockInteraction.breakSelectedBlock():this.rightMouseDown&&this.blockInteraction.placeSelectedBlock()}},this.physics=t,this.blockInteraction=i,this.grabControlElement=s,window.addEventListener("keypress",n=>{n.key==="f"&&(this.fast=!this.fast)}),window.addEventListener("keydown",n=>this.keys.add(n.code)),window.addEventListener("keyup",n=>this.keys.delete(n.code)),this.grabControlElement.addEventListener("click",n=>{this.grabControlElement.requestPointerLock()}),document.addEventListener("pointerlockchange",n=>{this.controlsEnabled=document.pointerLockElement===this.grabControlElement}),window.addEventListener("mousemove",n=>{if(!this.controlsEnabled)return;const h=.0015;this.yaw-=n.movementX*h,this.pitch-=n.movementY*h,this.pitch=gt(this.pitch,F(-89.9),F(89.9))}),window.addEventListener("mousedown",n=>{n.button===0?this.leftMouseDown=!0:n.button===2&&(this.rightMouseDown=!0)}),window.addEventListener("mouseup",n=>{n.button===0?this.leftMouseDown=!1:n.button===2&&(this.rightMouseDown=!1)})}}class Dt extends V{constructor(s){super(),this.applySystem=t=>{this.camera.setDir(t.dir),this.camera.setPos(t.pos)},this.camera=s}}class Pt extends V{constructor(s){super(),this.upVel=0,this.wantGo=[0,0,0],this.wantJump=!1,this.go=t=>{this.wantGo=A(this.wantGo,t)},this.jump=()=>{this.wantJump=!0},this.applySystem=t=>{t.pos=A(t.pos,this.wantGo),this.wantGo=[0,0,0]},this.world=s}}class Nt extends V{constructor(s,t){super(),this.placeID=2,this.ray=null,this.breakRequests=new Map,this.placeRequests=new Map,this.breakSelectedBlock=()=>{if(this.ray){const i=JSON.stringify(this.ray.coords),n=this.breakRequests.get(i);this.breakRequests.set(i,n===void 0?0:n+1)}},this.placeSelectedBlock=()=>{if(this.ray){const i=JSON.stringify(A(this.ray.coords,at(this.ray.face))),n=this.placeRequests.get(i);this.placeRequests.set(i,n===void 0?0:n+1)}},this.applySystem=i=>{for(const[n,h]of this.breakRequests)h>30&&(this.world.setBlock(JSON.parse(n),0),this.breakRequests.delete(n));for(const[n,h]of this.placeRequests)h>20&&(this.world.setBlock(JSON.parse(n),this.placeID),this.placeRequests.delete(n));this.ray=this.world.castRay(this.camera.getPos(),this.camera.getDir(),100),this.ray?this.world.addHighlight(this.uniqueId,this.ray):this.world.removeHighlight(this.uniqueId)},this.uniqueId=bt(32),this.camera=s,this.world=t}}const Z=[0,-1,0];class It{constructor(s,t){this.resizeCanvas=()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight},this.displayHelp=()=>this.animationLoop(),this.updateTime=!1,this.animationLoop=()=>{for(const g of this.entityList)g.update();this.updateTime?this.world.update(this.camera.getPos()):this.world.render(this.camera.getMvp()),this.updateTime=!this.updateTime,this.requestID=window.requestAnimationFrame(this.animationLoop)},this.canvas=s,this.blockManager=t,this.camera=new xt([0,0,0],[0,0,1],this.canvas,Z),this.gl=s.getContext("webgl2"),this.world=new wt(46,this.camera.getPos(),Z,this.gl,t,this.camera);const i=new Pt(this.world),n=new Nt(this.camera,this.world),h=new Mt([new St(this.canvas,i,n),new Dt(this.camera),i,n],Z);this.entityList=[h],this.resizeCanvas(),window.addEventListener("resize",this.resizeCanvas)}}async function N(e){return new Promise((s,t)=>{const i=document.getElementById(e);i.onerror=t,i.onload=()=>s(i),i.complete&&s(i)})}async function G(e){return await Promise.all([N(`${e}-left`),N(`${e}-right`),N(`${e}-up`),N(`${e}-down`),N(`${e}-front`),N(`${e}-back`)])}async function Ut(){const e=new dt(16,[{name:"air",pointable:!1,light:!1,transparent:!0},{name:"grass",pointable:!0,light:!1,transparent:!1,textures:await G("grass")},{name:"soil",pointable:!0,light:!1,transparent:!1,textures:await G("soil")},{name:"stone",pointable:!0,light:!1,transparent:!1,textures:await G("stone")},{name:"glass",pointable:!0,light:!1,transparent:!0,textures:await G("glass")},{name:"light",pointable:!0,light:!0,transparent:!1,textures:await G("light")}]),s=document.getElementById("canvas");new It(s,e).displayHelp()}Ut();
