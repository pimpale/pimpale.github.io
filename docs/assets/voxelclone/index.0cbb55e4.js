import"../modulepreload-polyfill.b7f2da20.js";import{m as ot}from"../mod.4956582c.js";function J(t){return Math.PI*t/180}function O(t){let i=0;for(const s of t)i+=s*s;const o=Math.sqrt(i);return t.map(s=>s/o)}function X([t,i,o]){return[t,i,o]}function q([t,i,o],[s,n,c]){return t*s+i*n+o*c}function W([t,i,o],[s,n,c]){return[i*c-o*n,o*s-t*c,t*n-i*s]}function R(t,i){return[t[0]*i,t[1]*i,t[2]*i]}function L(t,i){return[t[0]+i[0],t[1]+i[1],t[2]+i[2]]}function st(t,i){return[t[0]-i[0],t[1]-i[1],t[2]-i[2]]}function it(t){const[i,o,s,n]=t;return[[i[0],o[0],s[0],n[0]],[i[1],o[1],s[1],n[1]],[i[2],o[2],s[2],n[2]],[i[3],o[3],s[3],n[3]]]}function nt(t,i,o,s){const n=1/Math.tan(t/2),c=s-o;return[[n/i,0,0,0],[0,n,0,0],[0,0,-(o+s)/c,-2*o*s/c],[0,0,-1,0]]}function ht(t,i,o){let s=O(st(i,t));const n=O(W(s,o)),c=O(W(n,s));if(!n.every(h=>h==h))throw"Two parallel vectors were given";s=R(s,-1);const r=rt(-q(n,t),-q(c,t),-q(s,t)),e=[[n[0],n[1],n[2],0],[c[0],c[1],c[2],0],[s[0],s[1],s[2],0],[0,0,0,1]];return et(r,e)}function rt(t,i,o){return[[1,0,0,t],[0,1,0,i],[0,0,1,o],[0,0,0,1]]}function A(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3]}function et(t,i){const[o,s,n,c]=t,[r,e,h,a]=it(i);return[[A(o,r),A(o,e),A(o,h),A(o,a)],[A(s,r),A(s,e),A(s,h),A(s,a)],[A(n,r),A(n,e),A(n,h),A(n,a)],[A(c,r),A(c,e),A(c,h),A(c,a)]]}function at(t){const[i,o,s,n]=it(t);return[...i,...o,...s,...n]}function ct(t,i,o){return Math.min(Math.max(t,i),o)}function j(t,i){if(!t)throw new Error(i)}function z(t,i){const o=t%i;return o<0?o+i:o}var k=(t=>(t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.UP=2]="UP",t[t.DOWN=3]="DOWN",t[t.FRONT=4]="FRONT",t[t.BACK=5]="BACK",t))(k||{});function G(t){switch(t){case 0:return[-1,0,0];case 1:return[1,0,0];case 2:return[0,-1,0];case 3:return[0,1,0];case 5:return[0,0,-1];case 4:return[0,0,1]}}class ut{constructor(i,o){this.buildTextureAtlas=s=>{let n=s.createTexture();s.bindTexture(s.TEXTURE_2D_ARRAY,n),s.pixelStorei(s.UNPACK_ALIGNMENT,1),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MAG_FILTER,s.NEAREST);const c=new Uint8Array(this.tileSize*this.tileSize*this.defs.length*6*4);s.texImage3D(s.TEXTURE_2D_ARRAY,0,s.RGBA,this.tileSize,this.tileSize,this.defs.length*6,0,s.RGBA,s.UNSIGNED_BYTE,c);for(let r=0;r<this.defs.length;r++){const e=this.defs[r];if(e.textures!==void 0)for(let h=0;h<e.textures.length;h++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,r*6+h,this.tileSize,this.tileSize,1,s.RGBA,s.UNSIGNED_BYTE,e.textures[h])}return s.generateMipmap(s.TEXTURE_2D_ARRAY),n},this.tileSize=i,this.defs=o;for(let s=0;s<this.defs.length;s++){const n=this.defs[s];if(n.textures!==void 0)for(let c=0;c<n.textures.length;c++){const r=n.textures[c];j(r.height===i,`block #${s} face #${c} height != ${i}, found ${r.height}`),j(r.width===i,`block #${s} face #${c} width != ${i}, found ${r.width}`)}}}}function Q(t,i,o){const s=t.createShader(i);return t.shaderSource(s,o),t.compileShader(s),s}function lt(t,i){const o=t.createProgram();for(const n of i)t.attachShader(o,n);if(t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS))return o;for(const n of i)t.getShaderParameter(n,t.COMPILE_STATUS)||console.log(t.getShaderInfoLog(n)),t.deleteShader(n);return console.log(t.getProgramInfoLog(o)),t.deleteProgram(o),null}const pt=1,ft=1,dt=1,I=16,S=16,C=16,Y=3,$=3,V=3;class gt{constructor(i,o,s,n,c,r){this.emptyChunk=new Uint16Array(I*S*C),this.getWorldChunkLoc=e=>[Math.floor(e[0]/I),Math.floor(e[1]/S),Math.floor(e[2]/C)],this.createGraphics=e=>{const h=new Float32Array(e.length*6);for(let p=0;p<e.length;p++){const{position:[f,g,m],tuv:[w,y,_]}=e[p];h[p*6+0]=f,h[p*6+1]=g,h[p*6+2]=m,h[p*6+3]=w,h[p*6+4]=y,h[p*6+5]=_}const a=this.gl.createVertexArray();this.gl.bindVertexArray(a);const l=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l),this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.glPositionLoc),this.gl.vertexAttribPointer(this.glPositionLoc,3,this.gl.FLOAT,!1,6*4,0*4),this.gl.enableVertexAttribArray(this.glTuvLoc),this.gl.vertexAttribPointer(this.glTuvLoc,3,this.gl.FLOAT,!1,6*4,3*4),{vao:a,buffer:l,vertexCount:e.length}},this.deleteGraphics=e=>{this.gl.deleteBuffer(e.buffer),this.gl.deleteVertexArray(e.vao)},this.updateCameraLoc=()=>{const e=h=>{const a=st(h,this.worldChunkCenterLoc);return a[0]>=-Y&&a[0]<=Y&&a[1]>=-$&&a[1]<=$&&a[2]>=-V&&a[2]<=V};for(const[h,a]of this.chunk_map)e(JSON.parse(h))||(a.graphics!==void 0&&(this.deleteGraphics(a.graphics.solid),this.deleteGraphics(a.graphics.transparent),a.graphics=void 0),this.chunk_map.delete(h));for(let h=-Y;h<=Y;h++)for(let a=-$;a<=$;a++)for(let l=-V;l<=V;l++){const p=JSON.stringify(L(this.worldChunkCenterLoc,[h,a,l]));this.chunk_map.get(p)===void 0&&this.chunk_map.set(p,{})}},this.addHighlight=(e,h)=>{const a=this.highlights.get(e),l=kt(h.coords,h.face,this.blockManager);a===void 0?this.highlights.set(e,this.createGraphics(l)):(this.deleteGraphics(a),this.highlights.set(e,this.createGraphics(l)))},this.removeHighlight=e=>{const h=this.highlights.get(e);h!==void 0&&(this.deleteGraphics(h),this.highlights.delete(e))},this.markNeighboringChunksStale=e=>{const h=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];for(const a of h){const l=this.chunk_map.get(JSON.stringify(L(e,a)));l!==void 0&&l.mesh!==void 0&&(l.mesh.stale=!0)}},this.getChunkBlocksIfExists=e=>{var a;const h=(a=this.chunk_map.get(JSON.stringify(e)))==null?void 0:a.blocks;return h||this.emptyChunk},this.update=e=>{let h=0;for(const[l,p]of this.chunk_map){if(p.blocks===void 0){const m=JSON.parse(l);p.blocks=vt(m,this.noiseFn),this.markNeighboringChunksStale(m),h+=pt}if(h>1)break;const f=JSON.parse(l),g=[f[0]*I,f[1]*S,f[2]*C];if(p.mesh===void 0||p.mesh.stale){const{solid:m,transparent:w}=mt(g,this.blockManager,p.blocks,this.getChunkBlocksIfExists(L(f,[-1,0,0])),this.getChunkBlocksIfExists(L(f,[1,0,0])),this.getChunkBlocksIfExists(L(f,[0,-1,0])),this.getChunkBlocksIfExists(L(f,[0,1,0])),this.getChunkBlocksIfExists(L(f,[0,0,-1])),this.getChunkBlocksIfExists(L(f,[0,0,1])));p.mesh={solid:m,transparent:w,stale:!1},p.graphics!==void 0&&(p.graphics.stale=!0),h+=ft}if(h>1||((p.graphics===void 0||p.graphics.stale)&&(p.graphics!==void 0&&(this.deleteGraphics(p.graphics.solid),this.deleteGraphics(p.graphics.transparent)),p.graphics={solid:this.createGraphics(p.mesh.solid),transparent:this.createGraphics(p.mesh.transparent),stale:!1},h+=dt),h>1))break}const a=this.getWorldChunkLoc(e);(a[0]!==this.worldChunkCenterLoc[0]||a[1]!==this.worldChunkCenterLoc[1]||a[2]!==this.worldChunkCenterLoc[2])&&(this.worldChunkCenterLoc=a,this.updateCameraLoc())},this.render=()=>{this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.BLEND),this.gl.depthMask(!0);for(const e of this.chunk_map.values())e.graphics!==void 0&&(this.gl.bindVertexArray(e.graphics.solid.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,e.graphics.solid.vertexCount));for(const e of this.highlights.values())this.gl.bindVertexArray(e.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,e.vertexCount);this.gl.depthMask(!1);for(const e of this.chunk_map.values())e.graphics!==void 0&&(this.gl.bindVertexArray(e.graphics.transparent.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,e.graphics.transparent.vertexCount))},this.getBlock=e=>{const h=this.chunk_map.get(JSON.stringify(this.getWorldChunkLoc(e)));return h&&h.blocks?h.blocks[x(z(e[0],I),z(e[1],S),z(e[2],C))]:null},this.setBlock=(e,h)=>{const a=this.getWorldChunkLoc(e),l=this.chunk_map.get(JSON.stringify(a));if(l&&l.blocks){const p=z(e[0],I),f=z(e[1],S),g=z(e[2],C);return l.blocks[x(p,f,g)]=h,l.mesh!==void 0&&(l.mesh.stale=!0),this.markNeighboringChunksStale(a),!0}else return!1},this.intbound=(e,h)=>{const a=Math.round(e)==e;if(h<0&&a)return 0;let l;return e==0?l=1:l=Math.ceil(e),(h>0?l-e:e-Math.floor(e))/Math.abs(h)},this.castRay=(e,h,a)=>{let l=Math.floor(e[0]),p=Math.floor(e[1]),f=Math.floor(e[2]);const[g,m,w]=h,y=Math.sign(g),_=Math.sign(m),E=Math.sign(w);let u=this.intbound(e[0],g),D=this.intbound(e[1],m),b=this.intbound(e[2],w);const U=y/g,P=_/m,B=E/w;j(q(h,h)!==0,"direction vector is 0");const N=a/Math.sqrt(g*g+m*m+w*w);let M=k.UP;for(;;){const H=this.getBlock([l,p,f]);if(H===null)break;if(this.blockManager.defs[H].pointable)return{coords:[l,p,f],face:M};if(u<D)if(u<b){if(u>N)break;l+=y,u+=U,M=y==1?k.LEFT:k.RIGHT}else{if(b>N)break;f+=E,b+=B,M=E==1?k.BACK:k.FRONT}else if(D<b){if(D>N)break;p+=_,D+=P,M=_==1?k.UP:k.DOWN}else{if(b>N)break;f+=E,b+=B,M=E==1?k.BACK:k.FRONT}}return null},this.gl=s,this.blockManager=r,this.glPositionLoc=n,this.glTuvLoc=c,this.seed=i,this.noiseFn=ot.makeNoise3D(i),this.worldChunkCenterLoc=this.getWorldChunkLoc(o),this.chunk_map=new Map,this.lights=[],this.highlights=new Map,this.updateCameraLoc()}}function x(t,i,o){return Math.floor(t)*S*C+Math.floor(i)*C+Math.floor(o)}function vt(t,i){const o=[t[0]*I,t[1]*S,t[2]*C],s=new Uint16Array(I*S*C),n=20;for(let c=0;c<I;c++)for(let r=0;r<S;r++)for(let e=0;e<C;e++){const h=x(c,r,e),a=c+o[0],l=r+o[1],p=e+o[2],f=i(a/n,l/n,p/n),g=i(a/n,(l-1)/n,p/n);f>0?g>0?s[h]=3:s[h]=1:s[h]=0}return s[0]=4,s[1]=0,s[2]=4,s[3]=5,s}function T(t,i){return!(t.textures===void 0||!t.transparent&&!i.transparent||t==i)}function mt(t,i,o,s,n,c,r,e,h){const a=[],l=[],p=[];for(let f=0;f<I;f++)for(let g=0;g<S;g++)for(let m=0;m<C;m++){const w=o[x(f,g,m)],y=i.defs[w];if(y.textures===void 0)continue;const _=f+t[0],E=g+t[1],u=m+t[2],D=[_+0,E+0,u+0],b=[_+1,E+0,u+0],U=[_+0,E+0,u+1],P=[_+1,E+0,u+1],B=[_+0,E+1,u+0],N=[_+1,E+1,u+0],M=[_+0,E+1,u+1],H=[_+1,E+1,u+1],K=[_+.5,E+.5,u+.5],v=y.transparent?p:l;if(f===0?T(y,i.defs[s[x(I-1,g,m)]]):T(y,i.defs[o[x(f-1,g,m)]])){const d=w*6+k.LEFT;v.push({position:D,tuv:[1,0,d]}),v.push({position:U,tuv:[0,0,d]}),v.push({position:B,tuv:[1,1,d]}),v.push({position:U,tuv:[0,0,d]}),v.push({position:M,tuv:[0,1,d]}),v.push({position:B,tuv:[1,1,d]}),y.light&&a.push({pos:K,dir:G(k.LEFT)})}if(f===I-1?T(y,i.defs[n[x(0,g,m)]]):T(y,i.defs[o[x(f+1,g,m)]])){const d=w*6+k.RIGHT;v.push({position:b,tuv:[0,0,d]}),v.push({position:N,tuv:[0,1,d]}),v.push({position:P,tuv:[1,0,d]}),v.push({position:P,tuv:[1,0,d]}),v.push({position:N,tuv:[0,1,d]}),v.push({position:H,tuv:[1,1,d]}),y.light&&a.push({pos:K,dir:G(k.RIGHT)})}if(g===0?T(y,i.defs[c[x(f,S-1,m)]]):T(y,i.defs[o[x(f,g-1,m)]])){const d=w*6+k.UP;v.push({position:U,tuv:[1,1,d]}),v.push({position:D,tuv:[1,0,d]}),v.push({position:b,tuv:[0,0,d]}),v.push({position:U,tuv:[1,1,d]}),v.push({position:b,tuv:[0,0,d]}),v.push({position:P,tuv:[0,1,d]}),y.light&&a.push({pos:K,dir:G(k.UP)})}if(g===S-1?T(y,i.defs[r[x(f,0,m)]]):T(y,i.defs[o[x(f,g+1,m)]])){const d=w*6+k.DOWN;v.push({position:B,tuv:[0,0,d]}),v.push({position:M,tuv:[0,1,d]}),v.push({position:N,tuv:[1,0,d]}),v.push({position:N,tuv:[1,0,d]}),v.push({position:M,tuv:[0,1,d]}),v.push({position:H,tuv:[1,1,d]}),y.light&&a.push({pos:K,dir:G(k.DOWN)})}if(m===0?T(y,i.defs[e[x(f,g,C-1)]]):T(y,i.defs[o[x(f,g,m-1)]])){const d=w*6+k.BACK;v.push({position:D,tuv:[0,0,d]}),v.push({position:B,tuv:[0,1,d]}),v.push({position:b,tuv:[1,0,d]}),v.push({position:b,tuv:[1,0,d]}),v.push({position:B,tuv:[0,1,d]}),v.push({position:N,tuv:[1,1,d]}),y.light&&a.push({pos:K,dir:G(k.BACK)})}if(m===C-1?T(y,i.defs[h[x(f,g,0)]]):T(y,i.defs[o[x(f,g,m+1)]])){const d=w*6+k.FRONT;v.push({position:M,tuv:[1,1,d]}),v.push({position:U,tuv:[1,0,d]}),v.push({position:P,tuv:[0,0,d]}),v.push({position:M,tuv:[1,1,d]}),v.push({position:P,tuv:[0,0,d]}),v.push({position:H,tuv:[0,1,d]}),y.light&&a.push({pos:K,dir:G(k.FRONT)})}}return{solid:l,transparent:p,lights:a}}function kt(t,i,o){const r=[],h=t[0],a=t[1],l=t[2],p=[h+-.05,a+-.05,l+-.05],f=[h+1.05,a+-.05,l+-.05],g=[h+-.05,a+-.05,l+1.05],m=[h+1.05,a+-.05,l+1.05],w=[h+-.05,a+1.05,l+-.05],y=[h+1.05,a+1.05,l+-.05],_=[h+-.05,a+1.05,l+1.05],E=[h+1.05,a+1.05,l+1.05];switch(i){case k.LEFT:{const u=12+k.LEFT;r.push({position:p,tuv:[1,0,u]}),r.push({position:g,tuv:[0,0,u]}),r.push({position:w,tuv:[1,1,u]}),r.push({position:g,tuv:[0,0,u]}),r.push({position:_,tuv:[0,1,u]}),r.push({position:w,tuv:[1,1,u]});break}case k.RIGHT:{const u=12+k.RIGHT;r.push({position:f,tuv:[0,0,u]}),r.push({position:y,tuv:[0,1,u]}),r.push({position:m,tuv:[1,0,u]}),r.push({position:m,tuv:[1,0,u]}),r.push({position:y,tuv:[0,1,u]}),r.push({position:E,tuv:[1,1,u]});break}case k.UP:{const u=12+k.UP;r.push({position:g,tuv:[1,1,u]}),r.push({position:p,tuv:[1,0,u]}),r.push({position:f,tuv:[0,0,u]}),r.push({position:g,tuv:[1,1,u]}),r.push({position:f,tuv:[0,0,u]}),r.push({position:m,tuv:[0,1,u]});break}case k.DOWN:{const u=12+k.DOWN;r.push({position:w,tuv:[0,0,u]}),r.push({position:_,tuv:[0,1,u]}),r.push({position:y,tuv:[1,0,u]}),r.push({position:y,tuv:[1,0,u]}),r.push({position:_,tuv:[0,1,u]}),r.push({position:E,tuv:[1,1,u]});break}case k.BACK:{const u=12+k.BACK;r.push({position:p,tuv:[0,0,u]}),r.push({position:w,tuv:[0,1,u]}),r.push({position:f,tuv:[1,0,u]}),r.push({position:f,tuv:[1,0,u]}),r.push({position:w,tuv:[0,1,u]}),r.push({position:y,tuv:[1,1,u]});break}case k.FRONT:{const u=12+k.FRONT;r.push({position:_,tuv:[1,1,u]}),r.push({position:g,tuv:[1,0,u]}),r.push({position:m,tuv:[0,0,u]}),r.push({position:_,tuv:[1,1,u]}),r.push({position:m,tuv:[0,0,u]}),r.push({position:E,tuv:[0,1,u]});break}}return r}class yt{constructor(i,o,s){this.front=O([Math.cos(o)*Math.cos(i),Math.sin(i),Math.sin(o)*Math.cos(i)]),this.right=O(W(this.front,s)),this.up=O(W(this.right,this.front))}}class wt{constructor(i,o,s,n){this.getPos=()=>X(this.pos),this.setPos=c=>this.pos=X(c),this.getDir=()=>X(this.dir),this.setDir=c=>this.dir=X(c),this.getMvp=()=>{const c=J(90),r=this.canvas.width/this.canvas.height,e=nt(c,r,.001,1e3),h=ht(this.pos,L(this.pos,this.dir),this.worldup);return et(e,h)},this.pos=i,this.dir=o,this.canvas=s,this.worldup=n}}class Z{}function _t(t){function i(s){return s.toString(16).padStart(2,"0")}const o=new Uint8Array(t/2);return window.crypto.getRandomValues(o),Array.from(o,i).join("")}class Et{constructor(i,o,s,n){this.update=()=>{for(const c of this.components)c.applySystem(this)},this.components=i,this.worldup=o,this.pos=s===void 0?[0,0,0]:s,this.dir=n===void 0?[1,0,0]:n}}class At extends Z{constructor(i,o,s){super(),this.pitch=0,this.yaw=J(-90),this.controlsEnabled=!1,this.fast=!1,this.fly=!0,this.keys=new Set,this.leftMouseDown=!1,this.rightMouseDown=!1,this.applySystem=n=>{const c=new yt(this.pitch,this.yaw,n.worldup);if(n.dir=R(c.front,-1),this.controlsEnabled){const r=O(W(c.right,n.worldup));let e=this.fast?.1:.02;this.fly?(this.keys.has("KeyW")&&this.physics.go(R(r,e)),this.keys.has("KeyS")&&this.physics.go(R(r,-e)),this.keys.has("KeyA")&&this.physics.go(R(c.right,e)),this.keys.has("KeyD")&&this.physics.go(R(c.right,-e)),this.keys.has("ShiftLeft")&&this.physics.go(R(n.worldup,-e)),this.keys.has("Space")&&this.physics.go(R(n.worldup,e))):(this.keys.has("KeyW")&&this.physics.go(R(r,e)),this.keys.has("KeyS")&&this.physics.go(R(r,-e)),this.keys.has("KeyA")&&this.physics.go(R(c.right,e)),this.keys.has("KeyD")&&this.physics.go(R(c.right,-e)),this.keys.has("Space")&&this.physics.jump()),this.leftMouseDown?this.blockInteraction.breakSelectedBlock():this.rightMouseDown&&this.blockInteraction.placeSelectedBlock()}},this.physics=o,this.blockInteraction=s,this.grabControlElement=i,window.addEventListener("keypress",n=>{n.key==="f"&&(this.fast=!this.fast)}),window.addEventListener("keydown",n=>this.keys.add(n.code)),window.addEventListener("keyup",n=>this.keys.delete(n.code)),this.grabControlElement.addEventListener("click",n=>{this.grabControlElement.requestPointerLock()}),document.addEventListener("pointerlockchange",n=>{this.controlsEnabled=document.pointerLockElement===this.grabControlElement}),window.addEventListener("mousemove",n=>{if(!this.controlsEnabled)return;const c=.0015;this.yaw-=n.movementX*c,this.pitch-=n.movementY*c,this.pitch=ct(this.pitch,J(-89.9),J(89.9))}),window.addEventListener("mousedown",n=>{n.button===0?this.leftMouseDown=!0:n.button===2&&(this.rightMouseDown=!0)}),window.addEventListener("mouseup",n=>{n.button===0?this.leftMouseDown=!1:n.button===2&&(this.rightMouseDown=!1)})}}class xt extends Z{constructor(i){super(),this.applySystem=o=>{this.camera.setDir(o.dir),this.camera.setPos(o.pos)},this.camera=i}}class Ct extends Z{constructor(i){super(),this.upVel=0,this.wantGo=[0,0,0],this.wantJump=!1,this.go=o=>{this.wantGo=L(this.wantGo,o)},this.jump=()=>{this.wantJump=!0},this.applySystem=o=>{o.pos=L(o.pos,this.wantGo),this.wantGo=[0,0,0]},this.world=i}}class bt extends Z{constructor(i,o){super(),this.ray=null,this.lastBlockTime=0,this.breakSelectedBlock=()=>{const s=Date.now();this.ray&&this.lastBlockTime+50<s&&(this.world.setBlock(this.ray.coords,0),this.lastBlockTime=s)},this.placeSelectedBlock=()=>{const s=Date.now();if(this.ray&&this.lastBlockTime+50<s){const n=L(this.ray.coords,G(this.ray.face));this.world.setBlock(n,4),this.lastBlockTime=s}},this.applySystem=s=>{this.ray=this.world.castRay(this.camera.getPos(),this.camera.getDir(),100),this.ray?this.world.addHighlight(this.uniqueId,this.ray):this.world.removeHighlight(this.uniqueId)},this.uniqueId=_t(32),this.camera=i,this.world=o}}const tt=[0,-1,0],Tt=`#version 300 es
precision highp float;
layout(location=0) in vec3 a_position;
layout(location=1) in vec3 a_tuv;

// premultiplied mvp matrix
uniform mat4 u_mvpMat;

out vec3 v_tuv;

void main() {
   v_tuv = a_tuv;
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,Rt=`#version 300 es
precision highp float;
precision highp sampler2DArray;

// the texture atlas for the blocks
uniform sampler2DArray u_textureAtlas;
// the normal atlas for the blocks
uniform sampler2DArray u_normalAtlas;

// texCoord
in vec3 v_tuv;

out vec4 v_outColor;

void main() {
  vec4 color = texture(u_textureAtlas, v_tuv);

  v_outColor = vec4(color.rgb*color.a, color.a);
}
`;class Lt{constructor(i,o){this.resizeCanvas=()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)},this.displayHelp=()=>this.animationLoop(),this.animationLoop=()=>{for(const a of this.entityList)a.update();this.world.update(this.camera.getPos());{const a=this.camera.getMvp();this.gl.uniformMatrix4fv(this.mvpMatLoc,!1,at(a)),this.world.render()}this.requestID=window.requestAnimationFrame(this.animationLoop)},this.canvas=i,this.blockManager=o,this.camera=new wt([0,0,0],[0,0,1],this.canvas,tt),this.gl=i.getContext("webgl2");const s=lt(this.gl,[Q(this.gl,this.gl.VERTEX_SHADER,Tt),Q(this.gl,this.gl.FRAGMENT_SHADER,Rt)]);this.gl.useProgram(s);const n=this.gl.getAttribLocation(s,"a_position"),c=this.gl.getAttribLocation(s,"a_tuv");this.world=new gt(0,this.camera.getPos(),this.gl,n,c,o);const r=new Ct(this.world),e=new bt(this.camera,this.world),h=new Et([new At(this.canvas,r,e),new xt(this.camera),r,e],tt);this.entityList=[h],this.mvpMatLoc=this.gl.getUniformLocation(s,"u_mvpMat"),this.textureAtlasLoc=this.gl.getUniformLocation(s,"u_textureAtlas"),this.normalAtlasLoc=this.gl.getUniformLocation(s,"u_normalAtlas"),this.gl.activeTexture(this.gl.TEXTURE0),this.textureAtlas=this.blockManager.buildTextureAtlas(this.gl),this.gl.uniform1i(this.textureAtlasLoc,0),this.gl.activeTexture(this.gl.TEXTURE1),this.normalAtlas=this.blockManager.buildTextureAtlas(this.gl),this.gl.uniform1i(this.normalAtlasLoc,1),this.resizeCanvas(),this.canvas.addEventListener("resize",this.resizeCanvas)}}const St=document.getElementById("canvas");function F(t){return[document.getElementById(`${t}-left`),document.getElementById(`${t}-right`),document.getElementById(`${t}-up`),document.getElementById(`${t}-down`),document.getElementById(`${t}-front`),document.getElementById(`${t}-back`)]}const Mt=new ut(16,[{name:"air",pointable:!1,light:!1,transparent:!0},{name:"grass",pointable:!0,light:!1,transparent:!1,textures:F("grass")},{name:"soil",pointable:!0,light:!1,transparent:!1,textures:F("soil")},{name:"stone",pointable:!0,light:!1,transparent:!1,textures:F("stone")},{name:"glass",pointable:!0,light:!1,transparent:!0,textures:F("glass")},{name:"light",pointable:!0,light:!0,transparent:!1,textures:F("light")}]),It=new Lt(St,Mt);It.displayHelp();
