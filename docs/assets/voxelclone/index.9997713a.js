import"../modulepreload-polyfill.b7f2da20.js";import{m as ft}from"../mod.4956582c.js";function X(e){return Math.PI*e/180}function Q(e){let s=0;for(const t of e)s+=t*t;return Math.sqrt(s)}function L(e){const s=Q(e);return e.map(t=>t/s)}function V([e,s,t]){return[e,s,t]}function K([e,s,t],[h,n,a]){return e*h+s*n+t*a}function Y([e,s,t],[h,n,a]){return[s*a-t*n,t*h-e*a,e*n-s*h]}function R(e,s){return[e[0]*s,e[1]*s,e[2]*s]}function y(e,s){return[e[0]+s[0],e[1]+s[1],e[2]+s[2]]}function J(e,s){return[e[0]-s[0],e[1]-s[1],e[2]-s[2]]}function nt(e){const[s,t,h,n]=e;return[[s[0],t[0],h[0],n[0]],[s[1],t[1],h[1],n[1]],[s[2],t[2],h[2],n[2]],[s[3],t[3],h[3],n[3]]]}function ot(e,s,t,h){const n=1/Math.tan(e/2),a=h-t;return[[n/s,0,0,0],[0,n,0,0],[0,0,-(t+h)/a,-2*t*h/a],[0,0,-1,0]]}function at(e,s,t){let h=L(J(s,e));const n=L(Y(h,t)),a=L(Y(n,h));if(!n.every(o=>o==o))throw"two parallel vectors were given";h=R(h,-1);const r=pt(-K(n,e),-K(a,e),-K(h,e)),i=[[n[0],n[1],n[2],0],[a[0],a[1],a[2],0],[h[0],h[1],h[2],0],[0,0,0,1]];return st(r,i)}function pt(e,s,t){return[[1,0,0,e],[0,1,0,s],[0,0,1,t],[0,0,0,1]]}function T(e,s){return e[0]*s[0]+e[1]*s[1]+e[2]*s[2]+e[3]*s[3]}function st(e,s){const[t,h,n,a]=e,[r,i,o,l]=nt(s);return[[T(t,r),T(t,i),T(t,o),T(t,l)],[T(h,r),T(h,i),T(h,o),T(h,l)],[T(n,r),T(n,i),T(n,o),T(n,l)],[T(a,r),T(a,i),T(a,o),T(a,l)]]}function j(e){const[s,t,h,n]=nt(e);return[...s,...t,...h,...n]}function ct(e,s,t){return Math.min(Math.max(e,s),t)}function tt(e,s){if(!e)throw new Error(s)}function P(e,s){const t=e%s;return t<0?t+s:t}var E=(e=>(e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.UP=2]="UP",e[e.DOWN=3]="DOWN",e[e.FRONT=4]="FRONT",e[e.BACK=5]="BACK",e))(E||{});function lt(e){switch(e){case 0:return[-1,0,0];case 1:return[1,0,0];case 2:return[0,-1,0];case 3:return[0,1,0];case 5:return[0,0,-1];case 4:return[0,0,1]}}class dt{constructor(s,t){this.buildTextureAtlas=h=>{let n=h.createTexture();h.bindTexture(h.TEXTURE_2D_ARRAY,n),h.pixelStorei(h.UNPACK_ALIGNMENT,1),h.texParameteri(h.TEXTURE_2D_ARRAY,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D_ARRAY,h.TEXTURE_MAG_FILTER,h.NEAREST);const a=new Uint8Array(this.tileSize*this.tileSize*this.defs.length*6*4);h.texImage3D(h.TEXTURE_2D_ARRAY,0,h.RGBA,this.tileSize,this.tileSize,this.defs.length*6,0,h.RGBA,h.UNSIGNED_BYTE,a);for(let r=0;r<this.defs.length;r++){const i=this.defs[r];if(i.textures!==void 0)for(let o=0;o<i.textures.length;o++)h.texSubImage3D(h.TEXTURE_2D_ARRAY,0,0,0,r*6+o,this.tileSize,this.tileSize,1,h.RGBA,h.UNSIGNED_BYTE,i.textures[o])}return h.generateMipmap(h.TEXTURE_2D_ARRAY),n},this.tileSize=s,this.defs=t;for(let h=0;h<this.defs.length;h++){const n=this.defs[h];if(n.textures!==void 0)for(let a=0;a<n.textures.length;a++){const r=n.textures[a];tt(r.height===s,`block #${h} face #${a} height != ${s}, found ${r.height}`),tt(r.width===s,`block #${h} face #${a} width != ${s}, found ${r.width}`)}}}}function Z(e,s,t){const h=e.createShader(s);return e.shaderSource(h,t),e.compileShader(h),h}function ht(e,s,t){const h=e.createProgram();for(const a of s)e.attachShader(h,a);for(const[a,r]of t)e.bindAttribLocation(h,a,r);if(e.linkProgram(h),e.getProgramParameter(h,e.LINK_STATUS))return h;for(const a of s)e.getShaderParameter(a,e.COMPILE_STATUS)||console.log(e.getShaderInfoLog(a)),e.deleteShader(a);return console.log(e.getProgramInfoLog(h)),e.deleteProgram(h),null}const gt=1,mt=1,_t=1,vt=1,D=24,C=24,b=24,G=2,B=2,F=2,W=64,ut=18,H=9*ut,kt=`#version 300 es
precision highp int;
precision highp float;
uniform mat4 u_mvpMat;

in vec3 a_position;
out vec3 v_position;

in vec3 a_tuv;
out vec3 v_tuv;

in vec3 a_normal;
out vec3 v_normal;

void main() {
   v_tuv = a_tuv;
   v_normal = a_normal;
   v_position = a_position;
   // actual location
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,yt=`#version 300 es
precision highp int;
precision highp float;
precision highp sampler2DArray;

// the texture atlas for the blocks
uniform sampler2DArray u_textureAtlas;

uniform int u_lightNumber;

// the light depth maps
uniform sampler2DArray u_lightDepthArr;

// light position
uniform vec3 v_lightPosArr[${H}];

// camera view matrices of each point
uniform vec4 u_lightMvpArr[${H}*4];

// position
in vec3 v_position;

// normal
in vec3 v_normal;

// texCoord
in vec3 v_tuv;

out vec4 v_outColor;

void main() {
  vec4 color = texture(u_textureAtlas, v_tuv);

  float lightSum = 0.4;

  for(int i = 0; i < u_lightNumber; i++) {
    mat4 mvp = mat4(
        u_lightMvpArr[i*4 + 0],
        u_lightMvpArr[i*4 + 1],
        u_lightMvpArr[i*4 + 2],
        u_lightMvpArr[i*4 + 3]
    );
    vec4 lightSpacePosition = mvp * vec4(v_position, 1.0);

    vec3 projectedCoord = lightSpacePosition.xyz / lightSpacePosition.w;
    bool inRange =
        projectedCoord.z >= -1.0 &&
        projectedCoord.z <= 1.0 &&
        projectedCoord.x >= -1.0 &&
        projectedCoord.x <= 1.0 &&
        projectedCoord.y >= -1.0 &&
        projectedCoord.y <= 1.0;

    // remap coords to texCoords
    vec2 texCoord = (projectedCoord.xy + vec2(1.0, 1.0))/2.0;

    float depthMapDepth = texture(u_lightDepthArr, vec3(texCoord, i)).r;
    const float bias = 0.017;
    float currentDepth = (projectedCoord.z + 1.0)/2.0 - bias;

    if(inRange && currentDepth <= depthMapDepth) {
        float intensity = (1.0-currentDepth);
        vec3 lightDir = normalize(v_lightPosArr[i] - v_position);
        float diffuseIntensity = max(dot(v_normal, lightDir), 0.0);
        lightSum += 5.0*diffuseIntensity*intensity;
    }
  }
  v_outColor = vec4(color.rgb*lightSum, color.a);
}
`,Et=`#version 300 es
precision highp float;
in vec3 a_position;
uniform mat4 u_mvpMat;
void main() {
   gl_Position = u_mvpMat * vec4(a_position, 1.0);
}
`,xt=`#version 300 es
precision highp float;
precision highp sampler2DArray;
in vec3 v_tuv;
out vec4 v_outColor;

void main() {
  v_outColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`;class wt{constructor(s,t,h,n,a){this.POSITION_LOC=0,this.NORMAL_LOC=1,this.TUV_LOC=2,this.emptyChunk=new Uint16Array(D*C*b),this.getWorldChunkLoc=r=>[Math.floor(r[0]/D),Math.floor(r[1]/C),Math.floor(r[2]/b)],this.createGraphics=r=>{const i=this.gl.createVertexArray();this.gl.bindVertexArray(i);const o=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.POSITION_LOC),this.gl.vertexAttribPointer(this.POSITION_LOC,3,this.gl.FLOAT,!1,9*4,0*4),this.gl.enableVertexAttribArray(this.NORMAL_LOC),this.gl.vertexAttribPointer(this.NORMAL_LOC,3,this.gl.FLOAT,!1,9*4,3*4),this.gl.enableVertexAttribArray(this.TUV_LOC),this.gl.vertexAttribPointer(this.TUV_LOC,3,this.gl.FLOAT,!1,9*4,6*4),{vao:i,buffer:o,vertexCount:r.length/9}},this.deleteGraphics=r=>{this.gl.deleteBuffer(r.buffer),this.gl.deleteVertexArray(r.vao)},this.deleteChunkGraphics=r=>{this.deleteGraphics(r.solid),this.deleteGraphics(r.transparent)},this.shouldBeLoaded=r=>{const i=J(r,this.worldChunkCenterLoc);return i[0]>=-G&&i[0]<=G&&i[1]>=-B&&i[1]<=B&&i[2]>=-F&&i[2]<=F},this.updateCameraLoc=()=>{for(const[i,o]of this.chunk_map)this.shouldBeLoaded(JSON.parse(i))||(o.graphics!==void 0&&this.deleteChunkGraphics(o.graphics),o.lights!==void 0&&this.freeChunkLightingGPUData.push(o.lights.data),this.chunk_map.delete(i));const r=[];for(let i=-G;i<=G;i++)for(let o=-B;o<=B;o++)for(let l=-F;l<=F;l++)r.push(y(this.worldChunkCenterLoc,[i,o,l]));r.sort((i,o)=>{const l=Q(J(i,this.worldChunkCenterLoc)),c=Q(J(o,this.worldChunkCenterLoc));return l-c});for(const i of r){const o=JSON.stringify(i);this.chunk_map.get(o)===void 0&&this.chunk_map.set(o,{})}},this.addHighlight=(r,i)=>{const o=this.highlights.get(r);o!==void 0&&this.deleteGraphics(o);const l=this.createGraphics($([{bi:6,cubeLoc:i.coords,face:i.face}]));this.highlights.set(r,l)},this.removeHighlight=r=>{const i=this.highlights.get(r);i!==void 0&&(this.deleteGraphics(i),this.highlights.delete(r))},this.createLightMatrix=r=>{const i=y(r.cubeLoc,[.5,.5,.5]),o=ot(X(90),1,.5,10),l=r.face===E.UP||r.face===E.DOWN?[-1,0,0]:[0,-1,0],c=at(i,y(i,lt(r.face)),l);return st(o,c)},this.renderShadowMap=(r,i,o,l)=>{this.gl.useProgram(this.shadowProgram),this.gl.uniformMatrix4fv(this.shadowMvpMatLoc,!1,j(o)),this.gl.viewport(0,0,W,W),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i),this.gl.clear(this.gl.DEPTH_BUFFER_BIT);for(const c of l)this.gl.bindVertexArray(c.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,c.vertexCount)},this.adjacentChunkLocs=r=>[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]].map(o=>y(r,o)),this.neighboringChunkLocs=r=>{const i=[];for(let o=-1;o<=1;o++)for(let l=-1;l<=1;l++)for(let c=-1;c<=1;c++)(c!==0||l!==0||o!==0)&&i.push(y(r,[o,l,c]));return i},this.getChunkBlocksIfExists=r=>{var o;const i=(o=this.chunk_map.get(JSON.stringify(r)))==null?void 0:o.blocks;return i||this.emptyChunk},this.update=r=>{let i=0;t:for(const[l,c]of this.chunk_map){const m=JSON.parse(l);if(c.blocks===void 0){c.blocks=At(m,this.noiseFn);for(const d of this.adjacentChunkLocs(m)){const _=this.chunk_map.get(JSON.stringify(d));_&&_.mesh&&(_.mesh.stale=!0)}i+=gt}if(i>1)break t;const g=[m[0]*D,m[1]*C,m[2]*b];if(c.mesh===void 0||c.mesh.stale){for(const u of this.adjacentChunkLocs(m))if(this.shouldBeLoaded(u)){const f=this.chunk_map.get(JSON.stringify(u));if(f===void 0||f.blocks===void 0)continue t}const{solid:d,transparent:_,lights:x}=Tt(g,this.blockManager,c.blocks,this.getChunkBlocksIfExists(y(m,[-1,0,0])),this.getChunkBlocksIfExists(y(m,[1,0,0])),this.getChunkBlocksIfExists(y(m,[0,-1,0])),this.getChunkBlocksIfExists(y(m,[0,1,0])),this.getChunkBlocksIfExists(y(m,[0,0,-1])),this.getChunkBlocksIfExists(y(m,[0,0,1])));c.mesh={solid:d,transparent:_,lights:x,stale:!1},c.graphics!==void 0&&(c.graphics.stale=!0),c.lights!==void 0&&(c.lights.stale=!0);for(const u of this.neighboringChunkLocs(m)){const f=this.chunk_map.get(JSON.stringify(u));f&&f.lights&&(f.lights.stale=!0)}i+=mt}if(i>1||((c.graphics===void 0||c.graphics.stale)&&(c.graphics!==void 0&&this.deleteChunkGraphics(c.graphics),c.graphics={solid:this.createGraphics($(c.mesh.solid)),transparent:this.createGraphics($(c.mesh.transparent)),stale:!1},i+=_t),i>1))break t;if(c.lights===void 0||c.lights.stale){const d=[m,...this.neighboringChunkLocs(m)],_=d.flatMap(p=>{const A=this.chunk_map.get(JSON.stringify(p));return A&&A.mesh?A.mesh.lights.slice(0,ut):[]}).slice(0,H),x=d.flatMap(p=>{const A=this.chunk_map.get(JSON.stringify(p));return A&&A.graphics?[A.graphics.solid]:[]}),u=_.map(p=>y(p.cubeLoc,[.5,.5,.5])),f=_.map(p=>this.createLightMatrix(p)),k=new Float32Array(f.length*16);for(let p=0;p<f.length;p++)k.set(j(f[p]),p*16);const v=new Float32Array(u.length*3);for(let p=0;p<u.length;p++)v.set(u[p],p*3);if(c.lights===void 0){const p=this.freeChunkLightingGPUData.pop();if(p===void 0)continue;c.lights={matrixes:f,pos:u,data:p,stale:!0,mdata:k,pdata:v}}else c.lights.pos=u,c.lights.matrixes=f,c.lights.pdata=v,c.lights.mdata=k;for(let p=0;p<c.lights.matrixes.length;p++)this.renderShadowMap(c.lights.data.tex,c.lights.data.fbs[p],c.lights.matrixes[p],x);c.lights.stale=!1,i+=vt}if(i>1)break t}const o=this.getWorldChunkLoc(r);(o[0]!==this.worldChunkCenterLoc[0]||o[1]!==this.worldChunkCenterLoc[1]||o[2]!==this.worldChunkCenterLoc[2])&&(this.worldChunkCenterLoc=o,this.updateCameraLoc())},this.render=r=>{this.gl.useProgram(this.renderProgram),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.uniformMatrix4fv(this.renderMvpMatLoc,!1,j(r)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.textureAtlas),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(const i of this.chunk_map.values())i.graphics!==void 0&&i.lights!==void 0&&(this.gl.bindVertexArray(i.graphics.solid.vao),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.lights.data.tex),this.gl.uniform1i(this.renderLightNumber,i.lights.matrixes.length),i.lights.mdata.length!==0&&this.gl.uniform4fv(this.renderLightMvpArr,i.lights.mdata),i.lights.pdata.length!==0&&this.gl.uniform3fv(this.renderLightPosArr,i.lights.pdata),this.gl.drawArrays(this.gl.TRIANGLES,0,i.graphics.solid.vertexCount));this.gl.depthMask(!1);for(const i of this.chunk_map.values())i.graphics!==void 0&&(this.gl.bindVertexArray(i.graphics.transparent.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,i.graphics.transparent.vertexCount));this.gl.depthMask(!0),this.gl.disable(this.gl.DEPTH_TEST);for(const i of this.highlights.values())this.gl.bindVertexArray(i.vao),this.gl.drawArrays(this.gl.TRIANGLES,0,i.vertexCount)},this.getBlock=r=>{const i=this.chunk_map.get(JSON.stringify(this.getWorldChunkLoc(r)));return i&&i.blocks?i.blocks[w(P(r[0],D),P(r[1],C),P(r[2],b))]:null},this.setBlock=(r,i)=>{const o=m=>{const g=this.chunk_map.get(JSON.stringify(m));g&&g.mesh&&(g.mesh.stale=!0)},l=this.getWorldChunkLoc(r),c=this.chunk_map.get(JSON.stringify(l));if(c&&c.blocks){const m=Math.floor(P(r[0],D)),g=Math.floor(P(r[1],C)),d=Math.floor(P(r[2],b));return console.log(m,g,d),c.blocks[w(m,g,d)]=i,o(l),m===0&&o(y(l,[-1,0,0])),m===D-1&&o(y(l,[1,0,0])),g===0&&o(y(l,[0,-1,0])),g===C-1&&o(y(l,[0,1,0])),d===0&&o(y(l,[0,0,-1])),d===b-1&&o(y(l,[0,0,1])),!0}else return!1},this.intbound=(r,i)=>{const o=Math.round(r)==r;if(i<0&&o)return 0;let l;return r==0?l=1:l=Math.ceil(r),(i>0?l-r:r-Math.floor(r))/Math.abs(i)},this.castRay=(r,i,o)=>{let l=Math.floor(r[0]),c=Math.floor(r[1]),m=Math.floor(r[2]);const[g,d,_]=i,x=Math.sign(g),u=Math.sign(d),f=Math.sign(_);let k=this.intbound(r[0],g),v=this.intbound(r[1],d),p=this.intbound(r[2],_);const A=x/g,S=u/d,et=f/_;tt(K(i,i)!==0,"direction vector is 0");const z=o/Math.sqrt(g*g+d*d+_*_);let O=E.UP;for(;;){const it=this.getBlock([l,c,m]);if(it===null)break;if(this.blockManager.defs[it].pointable)return{coords:[l,c,m],face:O};if(k<v)if(k<p){if(k>z)break;l+=x,k+=A,O=x==1?E.LEFT:E.RIGHT}else{if(p>z)break;m+=f,p+=et,O=f==1?E.BACK:E.FRONT}else if(v<p){if(v>z)break;c+=u,v+=S,O=u==1?E.UP:E.DOWN}else{if(p>z)break;m+=f,p+=et,O=f==1?E.BACK:E.FRONT}}return null},this.gl=h,this.blockManager=n,this.seed=s,this.noiseFn=ft.makeNoise3D(s),this.worldChunkCenterLoc=this.getWorldChunkLoc(t),this.chunk_map=new Map,this.highlights=new Map,this.renderProgram=ht(this.gl,[Z(this.gl,this.gl.VERTEX_SHADER,kt),Z(this.gl,this.gl.FRAGMENT_SHADER,yt)],new Map([[this.POSITION_LOC,"a_position"],[this.NORMAL_LOC,"a_normal"],[this.TUV_LOC,"a_tuv"]])),this.gl.useProgram(this.renderProgram),this.renderMvpMatLoc=this.gl.getUniformLocation(this.renderProgram,"u_mvpMat"),this.renderTextureAtlasLoc=this.gl.getUniformLocation(this.renderProgram,"u_textureAtlas"),this.renderLightNumber=this.gl.getUniformLocation(this.renderProgram,"u_lightNumber"),this.renderLightDepthArr=this.gl.getUniformLocation(this.renderProgram,"u_lightDepthArr"),this.renderLightMvpArr=this.gl.getUniformLocation(this.renderProgram,"u_lightMvpArr"),this.renderLightPosArr=this.gl.getUniformLocation(this.renderProgram,"v_lightPosArr"),this.gl.activeTexture(this.gl.TEXTURE0),this.textureAtlas=this.blockManager.buildTextureAtlas(this.gl),this.gl.uniform1i(this.renderTextureAtlasLoc,0),this.gl.uniform1i(this.renderLightDepthArr,1),this.shadowProgram=ht(this.gl,[Z(this.gl,this.gl.VERTEX_SHADER,Et),Z(this.gl,this.gl.FRAGMENT_SHADER,xt)],new Map([[this.POSITION_LOC,"a_position"]])),this.gl.useProgram(this.shadowProgram),this.shadowMvpMatLoc=this.gl.getUniformLocation(this.shadowProgram,"u_mvpMat"),this.freeChunkLightingGPUData=[];for(let r=0;r<(G*2+1)*(B*2+1)*(F*2+1);r++)this.freeChunkLightingGPUData.push(bt(this.gl));this.updateCameraLoc()}}function w(e,s,t){return Math.floor(e)*C*b+Math.floor(s)*b+Math.floor(t)}function At(e,s){const t=[e[0]*D,e[1]*C,e[2]*b],h=new Uint16Array(D*C*b),n=20;for(let a=0;a<D;a++)for(let r=0;r<C;r++)for(let i=0;i<b;i++){const o=w(a,r,i),l=a+t[0],c=r+t[1],m=i+t[2],g=s(l/n,c/n,m/n),d=s(l/n,(c-1)/n,m/n);g>.5?d>.5?h[o]=3:h[o]=1:h[o]=0}return h[w(16,16,16)]=5,h}function M(e,s){return!(e.textures===void 0||!e.transparent&&!s.transparent||e==s)}function Tt(e,s,t,h,n,a,r,i,o){const l=[],c=[],m=[];for(let g=0;g<D;g++)for(let d=0;d<C;d++)for(let _=0;_<b;_++){const x=t[w(g,d,_)],u=[e[0]+g,e[1]+d,e[2]+_],f=s.defs[x];if(f.textures===void 0)continue;const k=f.transparent?m:c;if(g===0?M(f,s.defs[h[w(D-1,d,_)]]):M(f,s.defs[t[w(g-1,d,_)]])){const v={bi:x,cubeLoc:u,face:E.LEFT};k.push(v),f.light&&l.push(v)}if(g===D-1?M(f,s.defs[n[w(0,d,_)]]):M(f,s.defs[t[w(g+1,d,_)]])){const v={bi:x,cubeLoc:u,face:E.RIGHT};k.push(v),f.light&&l.push(v)}if(d===0?M(f,s.defs[a[w(g,C-1,_)]]):M(f,s.defs[t[w(g,d-1,_)]])){const v={bi:x,cubeLoc:u,face:E.UP};k.push(v),f.light&&l.push(v)}if(d===C-1?M(f,s.defs[r[w(g,0,_)]]):M(f,s.defs[t[w(g,d+1,_)]])){const v={bi:x,cubeLoc:u,face:E.DOWN};k.push(v),f.light&&l.push(v)}if(_===0?M(f,s.defs[i[w(g,d,b-1)]]):M(f,s.defs[t[w(g,d,_-1)]])){const v={bi:x,cubeLoc:u,face:E.BACK};k.push(v),f.light&&l.push(v)}if(_===b-1?M(f,s.defs[o[w(g,d,0)]]):M(f,s.defs[t[w(g,d,_+1)]])){const v={bi:x,cubeLoc:u,face:E.FRONT};k.push(v),f.light&&l.push(v)}}return{solid:c,transparent:m,lights:l}}function $(e){const s=new Float32Array(e.length*6*9);let t=0;for(const{bi:h,face:n,cubeLoc:[a,r,i]}of e){const o=[a+0,r+0,i+0],l=[a+1,r+0,i+0],c=[a+0,r+0,i+1],m=[a+1,r+0,i+1],g=[a+0,r+1,i+0],d=[a+1,r+1,i+0],_=[a+0,r+1,i+1],x=[a+1,r+1,i+1],u=h*6+n,f=[-1,0,0],k=[1,0,0],v=[0,-1,0],p=[0,1,0],A=[0,0,-1],S=[0,0,1];switch(n){case E.LEFT:{s.set(o,t),t+=3,s.set(f,t),t+=3,s.set([1,0,u],t),t+=3,s.set(c,t),t+=3,s.set(f,t),t+=3,s.set([0,0,u],t),t+=3,s.set(g,t),t+=3,s.set(f,t),t+=3,s.set([1,1,u],t),t+=3,s.set(c,t),t+=3,s.set(f,t),t+=3,s.set([0,0,u],t),t+=3,s.set(_,t),t+=3,s.set(f,t),t+=3,s.set([0,1,u],t),t+=3,s.set(g,t),t+=3,s.set(f,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.RIGHT:{s.set(l,t),t+=3,s.set(k,t),t+=3,s.set([0,0,u],t),t+=3,s.set(d,t),t+=3,s.set(k,t),t+=3,s.set([0,1,u],t),t+=3,s.set(m,t),t+=3,s.set(k,t),t+=3,s.set([1,0,u],t),t+=3,s.set(m,t),t+=3,s.set(k,t),t+=3,s.set([1,0,u],t),t+=3,s.set(d,t),t+=3,s.set(k,t),t+=3,s.set([0,1,u],t),t+=3,s.set(x,t),t+=3,s.set(k,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.UP:{s.set(c,t),t+=3,s.set(v,t),t+=3,s.set([1,1,u],t),t+=3,s.set(o,t),t+=3,s.set(v,t),t+=3,s.set([1,0,u],t),t+=3,s.set(l,t),t+=3,s.set(v,t),t+=3,s.set([0,0,u],t),t+=3,s.set(c,t),t+=3,s.set(v,t),t+=3,s.set([1,1,u],t),t+=3,s.set(l,t),t+=3,s.set(v,t),t+=3,s.set([0,0,u],t),t+=3,s.set(m,t),t+=3,s.set(v,t),t+=3,s.set([0,1,u],t),t+=3;break}case E.DOWN:{s.set(g,t),t+=3,s.set(p,t),t+=3,s.set([0,0,u],t),t+=3,s.set(_,t),t+=3,s.set(p,t),t+=3,s.set([0,1,u],t),t+=3,s.set(d,t),t+=3,s.set(p,t),t+=3,s.set([1,0,u],t),t+=3,s.set(d,t),t+=3,s.set(p,t),t+=3,s.set([1,0,u],t),t+=3,s.set(_,t),t+=3,s.set(p,t),t+=3,s.set([0,1,u],t),t+=3,s.set(x,t),t+=3,s.set(p,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.BACK:{s.set(o,t),t+=3,s.set(A,t),t+=3,s.set([0,0,u],t),t+=3,s.set(g,t),t+=3,s.set(A,t),t+=3,s.set([0,1,u],t),t+=3,s.set(l,t),t+=3,s.set(A,t),t+=3,s.set([1,0,u],t),t+=3,s.set(l,t),t+=3,s.set(A,t),t+=3,s.set([1,0,u],t),t+=3,s.set(g,t),t+=3,s.set(A,t),t+=3,s.set([0,1,u],t),t+=3,s.set(d,t),t+=3,s.set(A,t),t+=3,s.set([1,1,u],t),t+=3;break}case E.FRONT:{s.set(_,t),t+=3,s.set(S,t),t+=3,s.set([1,1,u],t),t+=3,s.set(c,t),t+=3,s.set(S,t),t+=3,s.set([1,0,u],t),t+=3,s.set(m,t),t+=3,s.set(S,t),t+=3,s.set([0,0,u],t),t+=3,s.set(_,t),t+=3,s.set(S,t),t+=3,s.set([1,1,u],t),t+=3,s.set(m,t),t+=3,s.set(S,t),t+=3,s.set([0,0,u],t),t+=3,s.set(x,t),t+=3,s.set(S,t),t+=3,s.set([0,1,u],t),t+=3;break}}}return s}const bt=e=>{const s=e.createTexture();e.bindTexture(e.TEXTURE_2D_ARRAY,s),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.DEPTH_COMPONENT32F,W,W,H,0,e.DEPTH_COMPONENT,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const t=[];for(let h=0;h<H;h++){const n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n),e.framebufferTextureLayer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,s,0,h),t.push(n)}return{tex:s,fbs:t}};class Rt{constructor(s,t,h){this.front=L([Math.cos(t)*Math.cos(s),Math.sin(s),Math.sin(t)*Math.cos(s)]),this.right=L(Y(this.front,h)),this.up=L(Y(this.right,this.front))}}class Ct{constructor(s,t,h){this.getPos=()=>V(this.pos),this.setPos=n=>this.pos=V(n),this.getDir=()=>V(this.dir),this.setDir=n=>this.dir=V(n),this.getMvp=n=>{const a=X(90),r=this.canvas.width/this.canvas.height,i=ot(a,r,.1,100),o=at(this.pos,y(this.pos,this.dir),n);return st(i,o)},this.pos=s,this.dir=t,this.canvas=h}}class q{}function Mt(e){function s(h){return h.toString(16).padStart(2,"0")}const t=new Uint8Array(e/2);return window.crypto.getRandomValues(t),Array.from(t,s).join("")}class Dt{constructor(s,t,h,n){this.update=()=>{for(const a of this.components)a.applySystem(this)},this.components=s,this.worldup=t,this.pos=h===void 0?[0,0,0]:h,this.dir=n===void 0?[1,0,0]:n}}class St extends q{constructor(s,t,h){super(),this.pitch=0,this.yaw=X(-90),this.controlsEnabled=!1,this.fast=!1,this.fly=!0,this.keys=new Set,this.leftMouseDown=!1,this.rightMouseDown=!1,this.applySystem=n=>{const a=new Rt(this.pitch,this.yaw,n.worldup);if(n.dir=R(a.front,-1),this.controlsEnabled){const r=L(Y(a.right,n.worldup));let i=this.fast?.1:.04;this.fly?(this.keys.has("KeyW")&&this.physics.go(R(r,i)),this.keys.has("KeyS")&&this.physics.go(R(r,-i)),this.keys.has("KeyA")&&this.physics.go(R(a.right,i)),this.keys.has("KeyD")&&this.physics.go(R(a.right,-i)),this.keys.has("ShiftLeft")&&this.physics.go(R(n.worldup,-i)),this.keys.has("Space")&&this.physics.go(R(n.worldup,i))):(this.keys.has("KeyW")&&this.physics.go(R(r,i)),this.keys.has("KeyS")&&this.physics.go(R(r,-i)),this.keys.has("KeyA")&&this.physics.go(R(a.right,i)),this.keys.has("KeyD")&&this.physics.go(R(a.right,-i)),this.keys.has("Space")&&this.physics.jump()),this.keys.has("Digit1")&&(this.blockInteraction.placeID=1),this.keys.has("Digit2")&&(this.blockInteraction.placeID=2),this.keys.has("Digit3")&&(this.blockInteraction.placeID=3),this.keys.has("Digit4")&&(this.blockInteraction.placeID=4),this.keys.has("Digit5")&&(this.blockInteraction.placeID=5),this.leftMouseDown?this.blockInteraction.breakSelectedBlock():this.rightMouseDown&&this.blockInteraction.placeSelectedBlock()}},this.physics=t,this.blockInteraction=h,this.grabControlElement=s,window.addEventListener("keypress",n=>{n.key==="f"&&(this.fast=!this.fast),n.key==="m"&&(this.fly?(this.fly=!1,this.physics.enablePhysics()):(this.fly=!0,this.physics.disablePhysics()))}),window.addEventListener("keydown",n=>this.keys.add(n.code)),window.addEventListener("keyup",n=>this.keys.delete(n.code)),this.grabControlElement.addEventListener("click",n=>{this.grabControlElement.requestPointerLock()}),document.addEventListener("pointerlockchange",n=>{this.controlsEnabled=document.pointerLockElement===this.grabControlElement}),window.addEventListener("mousemove",n=>{if(!this.controlsEnabled)return;const a=.0015;this.yaw-=n.movementX*a,this.pitch-=n.movementY*a,this.pitch=ct(this.pitch,X(-89.9),X(89.9))}),window.addEventListener("mousedown",n=>{n.button===0?this.leftMouseDown=!0:n.button===2&&(this.rightMouseDown=!0)}),window.addEventListener("mouseup",n=>{n.button===0?this.leftMouseDown=!1:n.button===2&&(this.rightMouseDown=!1)})}}class Lt extends q{constructor(s){super(),this.applySystem=t=>{this.camera.setDir(t.dir),this.camera.setPos(t.pos)},this.camera=s}}function I(e,s){return e.minX<=s.maxX&&e.maxX>=s.minX&&e.minY<=s.maxY&&e.maxY>=s.minY&&e.minZ<=s.maxZ&&e.maxZ>=s.minZ}class Pt extends q{constructor(s){super(),this.upVel=0,this.wantGo=[0,0,0],this.wantJump=!1,this.x_rad=.3,this.z_rad=.3,this.p_y_rad=1.5,this.n_y_rad=.3,this.side_depth=.1,this.head_depth=.1,this.foot_depth=.6,this.physicsEnabled=!1,this.enablePhysics=()=>this.physicsEnabled=!0,this.disablePhysics=()=>{this.physicsEnabled=!1,this.upVel=0},this.getPhysicsEnabled=()=>this.physicsEnabled,this.go=t=>{this.wantGo=y(this.wantGo,t)},this.jump=()=>{this.wantJump=!0},this.calculatePlayerIntersection=t=>{let h={minX:t[0]-this.x_rad,maxX:t[0]-this.x_rad+this.side_depth,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},n={minX:t[0]+this.x_rad-this.side_depth,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},a={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]-this.z_rad,maxZ:t[2]-this.z_rad+this.side_depth},r={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad+this.head_depth,maxY:t[1]+this.p_y_rad-this.foot_depth,minZ:t[2]+this.z_rad-this.side_depth,maxZ:t[2]+this.z_rad},i={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]-this.n_y_rad,maxY:t[1]-this.n_y_rad+this.head_depth,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},o={minX:t[0]-this.x_rad,maxX:t[0]+this.x_rad,minY:t[1]+this.p_y_rad-this.foot_depth,maxY:t[1]+this.p_y_rad,minZ:t[2]-this.z_rad,maxZ:t[2]+this.z_rad},l=!1,c=!1,m=!1,g=!1,d=!1,_=!1;for(let x=-2;x<=2;x++)for(let u=-2;u<=2;u++)for(let f=-2;f<=2;f++){const k=y(t,[x,u,f]).map(p=>Math.floor(p)),v=this.world.getBlock(k);if(v!=null&&this.world.blockManager.defs[v].pointable){let p={minX:k[0],maxX:k[0]+1,minY:k[1],maxY:k[1]+1,minZ:k[2],maxZ:k[2]+1};!l&&I(h,p)&&(l=!0),!c&&I(n,p)&&(c=!0),!m&&I(i,p)&&(m=!0),!g&&I(o,p)&&(g=!0),!d&&I(a,p)&&(d=!0),!_&&I(r,p)&&(_=!0)}}return{left:l,right:c,up:m,down:g,back:d,front:_}},this.applySystem=t=>{if(!this.physicsEnabled){t.pos=y(t.pos,this.wantGo),this.wantGo=[0,0,0];return}this.upVel-=.001,this.upVel=ct(this.upVel,-.1,.1),this.wantGo=y(this.wantGo,R(t.worldup,this.upVel));let h=y(t.pos,this.wantGo);const n=this.calculatePlayerIntersection(h);this.wantJump&&n.down&&(this.upVel=.05),this.wantJump=!1,n.left&&(this.wantGo[0]=Math.max(this.wantGo[0],0)),n.right&&(this.wantGo[0]=Math.min(this.wantGo[0],0)),n.up&&(this.wantGo[1]=Math.max(this.wantGo[1],0),this.upVel=Math.min(this.upVel,0)),n.down&&(this.wantGo[1]=Math.min(this.wantGo[1],0),this.upVel=Math.max(this.upVel,0)),n.back&&(this.wantGo[2]=Math.max(this.wantGo[2],0)),n.front&&(this.wantGo[2]=Math.min(this.wantGo[2],0)),t.pos=y(t.pos,this.wantGo),this.wantGo=[0,0,0]},this.world=s}}class It extends q{constructor(s,t){super(),this.placeID=2,this.ray=null,this.breakRequests=new Map,this.placeRequests=new Map,this.breakSelectedBlock=()=>{if(this.ray){const h=JSON.stringify(this.ray.coords),n=this.breakRequests.get(h);this.breakRequests.set(h,n===void 0?0:n+1)}},this.placeSelectedBlock=()=>{if(this.ray){const h=JSON.stringify(y(this.ray.coords,lt(this.ray.face))),n=this.placeRequests.get(h);this.placeRequests.set(h,n===void 0?0:n+1)}},this.applySystem=h=>{for(const[n,a]of this.breakRequests)a>30&&(this.world.setBlock(JSON.parse(n),0),this.breakRequests.delete(n));for(const[n,a]of this.placeRequests)a>20&&(this.world.setBlock(JSON.parse(n),this.placeID),this.placeRequests.delete(n));this.ray=this.world.castRay(this.camera.getPos(),this.camera.getDir(),100),this.ray?this.world.addHighlight(this.uniqueId,this.ray):this.world.removeHighlight(this.uniqueId)},this.uniqueId=Mt(32),this.camera=s,this.world=t}}const rt=[0,-1,0];class Nt{constructor(s,t){this.resizeCanvas=()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight},this.start=()=>this.animationLoop(),this.updateTime=!1,this.animationLoop=()=>{for(const r of this.entityList)r.update();this.updateTime?this.world.update(this.camera.getPos()):this.world.render(this.camera.getMvp(rt)),this.updateTime=!this.updateTime,this.requestID=window.requestAnimationFrame(this.animationLoop)},this.canvas=s,this.blockManager=t,this.camera=new Ct([0,0,0],[0,0,1],this.canvas),this.gl=s.getContext("webgl2"),this.world=new wt(42,this.camera.getPos(),this.gl,t,this.camera);const h=new Pt(this.world),n=new It(this.camera,this.world),a=new Dt([new St(this.canvas,h,n),new Lt(this.camera),h,n],rt);this.entityList=[a],this.resizeCanvas(),window.addEventListener("resize",this.resizeCanvas)}}async function N(e){return new Promise((s,t)=>{const h=document.getElementById(e);h.onerror=t,h.onload=()=>s(h),h.complete&&s(h)})}async function U(e){return await Promise.all([N(`${e}-left`),N(`${e}-right`),N(`${e}-up`),N(`${e}-down`),N(`${e}-front`),N(`${e}-back`)])}async function Ut(){const e=new dt(16,[{name:"air",pointable:!1,light:!1,transparent:!0},{name:"grass",pointable:!0,light:!1,transparent:!1,textures:await U("grass")},{name:"soil",pointable:!0,light:!1,transparent:!1,textures:await U("soil")},{name:"stone",pointable:!0,light:!1,transparent:!1,textures:await U("stone")},{name:"glass",pointable:!0,light:!1,transparent:!0,textures:await U("glass")},{name:"lamp",pointable:!0,light:!0,transparent:!1,textures:await U("lamp")},{name:"selector",pointable:!0,light:!1,transparent:!1,textures:await U("selector")}]),s=document.getElementById("canvas");new Nt(s,e).start()}Ut();
